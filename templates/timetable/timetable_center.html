{% extends 'base.html' %}
{% load static %}
{% load get_item %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-calendar"></i> Timetable Center</h2>
        <ul class="nav navbar-right panel_toolbox">
          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
        </ul>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <form method="get" class="form-horizontal form-label-left">
          <div class="form-group">
            <label class="control-label col-md-2 col-sm-3 col-xs-12">Select Class Stream:</label>
            <div class="col-md-6 col-sm-6 col-xs-12">
              <select name="class_stream_id" required onchange="this.form.submit()" class="form-control">
                <option value="">-- Select Class --</option>
                {% for class_stream in class_streams %}
                <option value="{{ class_stream.id }}" {% if selected_class and class_stream.id == selected_class.id %}selected{% endif %}>{{ class_stream }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </form>

        {% if selected_class %}
        <div class="row" style="margin-bottom:10px;">
          <div class="col-md-8 col-sm-12">
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
              <div class="checkbox" style="margin:0;">
                <label><input type="checkbox" id="editModeToggle"> Edit mode</label>
              </div>
              <div class="checkbox" style="margin:0;">
                <label><input type="checkbox" id="compactModeToggle"> Compact</label>
              </div>
              <div id="subject-legend" class="legend"></div>
            </div>
          </div>
          <div class="col-md-4 col-sm-12 text-right">
            <button type="button" class="btn btn-default btn-sm" id="clearAllBtn" title="Clear all selections"><i class="fa fa-eraser"></i> Clear</button>
            <button type="button" class="btn btn-primary btn-sm" onclick="window.print()" title="Print this timetable"><i class="fa fa-print"></i> Print</button>
            <form method="post" style="display:inline-block; margin-left:6px;">
              {% csrf_token %}
              <input type="hidden" name="class_stream_id" value="{{ selected_class.id }}">
              <input type="hidden" name="action" value="copy_previous">
              <button type="submit" class="btn btn-info btn-sm" title="Copy last term timetable into current term"><i class="fa fa-copy"></i> Copy previous</button>
            </form>
          </div>
        </div>

        <div class="table-responsive">
          <form id="timetableForm" method="post">
            {% csrf_token %}
            <input type="hidden" name="class_stream_id" value="{{ selected_class.id }}">
            <input type="hidden" name="timetable_json" id="timetable_json" />
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Time Slot</th>
                  {% for weekday, label in weekdays %}
                  <th>{{ label }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for slot in time_slots %}
                <tr>
                  <td>{{ slot }}</td>
                  {% for weekday, _ in weekdays %}
                  {% with key=weekday|stringformat:"s"|add:"_"|add:slot.id|stringformat:"s" %}
                  <td class="tt-cell" data-weekday="{{ weekday }}" data-timeslot="{{ slot.id }}">
                    {% with cell=timetable_data|get_item:weekday|get_item:slot.id %}
                    <div class="tt-visual">
                      {% if cell %}
                      <div class="tt-chip" draggable="true" data-subject-id="{{ cell.subject.id|default:'' }}" data-teacher-id="{{ cell.teacher.id|default:'' }}" data-classroom-id="{{ cell.classroom.id|default:'' }}">
                        <div class="line">
                          <span class="subject">{{ cell.subject|default:"Subject" }}</span>
                          <button type="button" class="clear" title="Clear" onclick="clearCell(this.closest('.tt-cell'))">&times;</button>
                        </div>
                        <div class="meta">
                          <i class="fa fa-user"></i> {{ cell.teacher|default:"—" }} &nbsp;&nbsp;
                          <i class="fa fa-building"></i> {{ cell.classroom|default:"TBD" }}
                        </div>
                      </div>
                      {% else %}
                      <span class="tt-empty">Empty</span>
                      {% endif %}
                    </div>
                    <div class="tt-edit-set">
                      <select name="{{ key }}_subject" data-weekday="{{ weekday }}" data-timeslot="{{ slot.id }}" class="form-control" style="margin-bottom:6px;">
                        <option value="">-- Subject --</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}" {% if cell and cell.subject.id == subject.id %}selected{% endif %}>{{ subject }}</option>
                        {% endfor %}
                      </select>
                      <select name="{{ key }}_teacher" data-weekday="{{ weekday }}" data-timeslot="{{ slot.id }}" class="form-control" style="margin-bottom:6px;">
                        <option value="">-- Teacher --</option>
                        {% for teacher in teachers %}
                        <option value="{{ teacher.id }}" {% if cell and cell.teacher.id == teacher.id %}selected{% endif %}>{{ teacher }}</option>
                        {% endfor %}
                      </select>
                      <select name="{{ key }}_classroom" data-weekday="{{ weekday }}" data-timeslot="{{ slot.id }}" class="form-control">
                        <option value="">-- Room (optional) --</option>
                        {% for room in classrooms %}
                        <option value="{{ room.id }}" {% if cell and cell.classroom and cell.classroom.id == room.id %}selected{% endif %}>{{ room }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    {% endwith %}
                  </td>
                  {% endwith %}
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="text-center" style="margin-top:12px;">
              <button type="button" class="btn btn-primary" onclick="submitTimetable()"><i class="fa fa-save"></i> Save Timetable</button>
            </div>
          </form>
        </div>
        {% else %}
        <div class="alert alert-info" role="alert" style="margin:0;">
          <i class="fa fa-info-circle"></i> Select a class stream to view and edit its timetable.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
.legend{display:flex;flex-wrap:wrap;gap:6px;}
.legend-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:.75rem;border:1px solid #e5e7eb;background:#fff;}
.legend-dot{width:10px;height:10px;border-radius:50%;background:var(--chip-color,#cbd5e1);box-shadow:inset 0 0 0 2px #fff;}
.tt-cell.warning{background:#fffbeb;outline:2px dashed #f59e0b;}
.tt-chip{border-left:6px solid var(--chip-color,#cbd5e1);}
.tt-empty{color:#94a3b8;font-style:italic;}
</style>

<script>
function subjectColor(id){if(!id)return'#cbd5e1';var h=0,s=70,l=75,str=String(id);for(var i=0;i<str.length;i++)h=(h*31+str.charCodeAt(i))%360;return'hsl('+h+', '+s+'%, '+l+'%)';}
function clearCell(td){if(!td)return;td.querySelectorAll('.tt-subject, .tt-teacher, .tt-room').forEach(function(sel){sel.value='';});renderCellPreview(td);computeWarnings();}
function renderCellPreview(td){var subjectSel=td.querySelector('.tt-subject');var teacherSel=td.querySelector('.tt-teacher');var roomSel=td.querySelector('.tt-room');var visual=td.querySelector('.tt-visual');var subjectId=subjectSel?subjectSel.value:'';var subjectName=subjectSel&&subjectSel.selectedOptions[0]?subjectSel.selectedOptions[0].text.trim():'';var teacherName=teacherSel&&teacherSel.value?teacherSel.selectedOptions[0].text.trim():'';var roomName=roomSel&&roomSel.value?roomSel.selectedOptions[0].text.trim():'';visual.innerHTML='';if(subjectId||teacherName||roomName){var chip=document.createElement('div');chip.className='tt-chip';chip.setAttribute('draggable','true');chip.style.setProperty('--chip-color',subjectColor(subjectId));chip.dataset.subjectId=subjectId||'';chip.dataset.teacherId=(teacherSel&&teacherSel.value)||'';chip.dataset.classroomId=(roomSel&&roomSel.value)||'';var top=document.createElement('div');top.className='line';var subjSpan=document.createElement('span');subjSpan.className='subject';subjSpan.textContent=subjectName||'Subject';var clearBtn=document.createElement('button');clearBtn.type='button';clearBtn.className='clear';clearBtn.title='Clear';clearBtn.innerHTML='&times;';clearBtn.addEventListener('click',function(){clearCell(td);});top.appendChild(subjSpan);top.appendChild(clearBtn);var meta=document.createElement('div');meta.className='meta';meta.innerHTML='<i class="fa fa-user"></i> '+(teacherName||'—')+' &nbsp;&nbsp; <i class="fa fa-building"></i> '+(roomName||'TBD');chip.appendChild(top);chip.appendChild(meta);chip.addEventListener('dragstart',function(e){e.dataTransfer.setData('text/plain',JSON.stringify({subject:(subjectSel&&subjectSel.value)||'',teacher:(teacherSel&&teacherSel.value)||'',classroom:(roomSel&&roomSel.value)||''}));e.dataTransfer.effectAllowed='move';td.classList.add('drag-origin');});chip.addEventListener('dragend',function(){td.classList.remove('drag-origin');});visual.appendChild(chip);}else{var empty=document.createElement('span');empty.className='tt-empty';empty.textContent='Empty';visual.appendChild(empty);}}
function handleDragOver(e){e.preventDefault();e.dataTransfer.dropEffect='move';}
function handleDrop(e){e.preventDefault();var td=e.currentTarget;var payload=e.dataTransfer.getData('text/plain');if(!payload)return;var data={};try{data=JSON.parse(payload);}catch(err){return;}var subjectSel=td.querySelector('.tt-subject');var teacherSel=td.querySelector('.tt-teacher');var roomSel=td.querySelector('.tt-room');if(subjectSel)subjectSel.value=data.subject||'';if(teacherSel)teacherSel.value=data.teacher||'';if(roomSel)roomSel.value=data.classroom||'';renderCellPreview(td);computeWarnings();}
function computeWarnings(){document.querySelectorAll('.tt-cell').forEach(function(td){var subject=(td.querySelector('.tt-subject')||{}).value||'';var teacher=(td.querySelector('.tt-teacher')||{}).value||'';var room=(td.querySelector('.tt-room')||{}).value||'';var onlyOneOfPair=(subject&&!teacher)||(!subject&&teacher);var roomButNoSubject=room&&!subject;td.classList.remove('warning');if(onlyOneOfPair||roomButNoSubject)td.classList.add('warning');});}
function populateLegend(){var legend=document.getElementById('subject-legend');if(!legend)return;legend.innerHTML='';var first=document.querySelector('.tt-subject');if(!first)return;var seen={};Array.prototype.forEach.call(first.options,function(opt){if(!opt.value)return;var id=opt.value;if(seen[id])return;seen[id]=true;var chip=document.createElement('span');chip.className='legend-chip';chip.style.setProperty('--chip-color',subjectColor(id));var dot=document.createElement('span');dot.className='legend-dot';var label=document.createElement('span');label.textContent=(opt.text||'').trim();chip.appendChild(dot);chip.appendChild(label);legend.appendChild(chip);});}
function initCells(){document.querySelectorAll('.tt-cell').forEach(function(td){renderCellPreview(td);td.addEventListener('dragover',handleDragOver);td.addEventListener('drop',handleDrop);td.querySelectorAll('select').forEach(function(sel){sel.addEventListener('change',function(){renderCellPreview(td);computeWarnings();});});});computeWarnings();populateLegend();}
function toggleEditMode(enabled){var table=document.querySelector('table');if(!table)return;if(enabled)table.classList.add('tt-edit-mode');else table.classList.remove('tt-edit-mode');}
function toggleCompactMode(enabled){var table=document.querySelector('table');if(!table)return;if(enabled)table.classList.add('compact');else table.classList.remove('compact');}
function clearAllCells(){document.querySelectorAll('.tt-cell').forEach(function(td){clearCell(td);});}
document.addEventListener('DOMContentLoaded',function(){initCells();var editToggle=document.getElementById('editModeToggle');var compactToggle=document.getElementById('compactModeToggle');var clearAllBtn=document.getElementById('clearAllBtn');if(editToggle){editToggle.addEventListener('change',function(e){toggleEditMode(e.target.checked);});toggleEditMode(editToggle.checked);}if(compactToggle){compactToggle.addEventListener('change',function(e){toggleCompactMode(e.target.checked);});}if(clearAllBtn){clearAllBtn.addEventListener('click',clearAllCells);}});
function submitTimetable(){var data={};document.querySelectorAll('select[data-weekday]').forEach(function(select){var weekday=select.getAttribute('data-weekday');var timeslot=select.getAttribute('data-timeslot');if(!data[weekday])data[weekday]={};if(!data[weekday][timeslot])data[weekday][timeslot]={};var name=select.name||'';if(name.indexOf('_subject',name.length-8)!==-1)data[weekday][timeslot].subject=select.value||null;else if(name.indexOf('_teacher',name.length-8)!==-1)data[weekday][timeslot].teacher=select.value||null;else if(name.indexOf('_classroom',name.length-10)!==-1)data[weekday][timeslot].classroom=select.value||null;});document.getElementById('timetable_json').value=JSON.stringify(data);document.getElementById('timetableForm').submit();}
</script>

<style>
  @media screen {
    body.force-nav-md.nav-sm .left_col { width: 230px !important; }
    body.force-nav-md.nav-sm .right_col { margin-left: 230px !important; }
    body.force-nav-md.nav-sm .navbar.nav_title { width: 230px !important; }
    body.force-nav-md.nav-sm .sidebar-footer { width: 230px !important; }
  }
</style>
<script>
(function () {
  var KEY = 'sidebar_collapsed';
  function enforceWideSidebar() {
    try {
      var b = document.body;
      if (!b) return;
      b.classList.add('force-nav-md');
      b.classList.remove('nav-sm');
      b.classList.add('nav-md');
      localStorage.setItem(KEY, '0');
    } catch (e) {}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enforceWideSidebar);
  } else {
    enforceWideSidebar();
  }
  setTimeout(enforceWideSidebar, 0);
  setTimeout(enforceWideSidebar, 50);
  setTimeout(enforceWideSidebar, 300);
  window.addEventListener('resize', function () { setTimeout(enforceWideSidebar, 0); });
})();
</script>
{% endblock %}
