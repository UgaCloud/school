{% extends "../base.html" %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block page_title %}Student Bill Details{% endblock %}

{% block content %}
<style>
    .profile_left {
        background: #f7f7f7;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .profile_img {
        text-align: center;
        margin-bottom: 20px;
    }
    .profile_img img {
        border-radius: 50%;
        width: 120px;
        height: 120px;
        object-fit: cover;
    }
    .user_data li {
        margin-bottom: 10px;
    }
    .progress {
        height: 20px;
    }
    .btn-info {
        margin-top: 10px;
    }
    .table {
        margin-top: 20px;
    }
    .receipt {
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .receipt h2, .receipt h3 {
        text-align: center;
        margin-bottom: 20px;
    }
    .receipt table {
        width: 100%;
        margin-bottom: 20px;
        border-collapse: collapse;
    }
    .receipt th, .receipt td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    .receipt th {
        background-color: #f2f2f2;
    }

    /* Gentellela theme progress bars - clean and professional */
    .progress {
        height: 20px;
        background: #f5f5f5;
        border-radius: 10px;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-top: 6px;
    }

    .progress-bar {
        height: 100%;
        border-radius: 10px;
        transition: width 0.6s ease;
        position: relative;
    }

    .progress-bar.total {
        background: linear-gradient(90deg, #3498db, #2980b9);
    }

    .progress-bar.paid {
        background: linear-gradient(90deg, #27ae60, #2ecc71);
    }

    .progress-bar.balance {
        background: linear-gradient(90deg, #e74c3c, #c0392b);
    }

    /* Gentellela theme button colors */
    .btn-primary {
        background: linear-gradient(90deg, #3498db, #2980b9);
        border-color: #2980b9;
    }

    .btn-primary:hover {
        background: linear-gradient(90deg, #2980b9, #3498db);
        border-color: #3498db;
    }
</style>

<div class="x_content">
    <div class="row">
        <div class="col-md-3 col-sm-3 profile_left">
            <div class="profile_img">
                <img class="img-responsive img-fluid" src="{{ student_bill.student.photo.url }}" alt="Avatar">
            </div>
            <h3>{{ student_bill.student.student_name }}</h3>
            <ul class="list-unstyled user_data">
                <li><i class="fa fa-map-marker user-profile-icon"></i> {{ student_bill.student.reg_no }}</li>
                <li><i class="fa fa-briefcase user-profile-icon"></i> {{ student_bill.student.current_class.code }}</li>
            </ul>

            <h4>Bill Summary</h4>


<ul class="list-unstyled user_data">
  <li>
    <p>Total Amount - {{ student_bill.total_amount|intcomma }}/-</p>
    <div class="progress" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" aria-label="Total Amount Progress">
      <div class="progress-bar total" style="width: 100%;"></div>
    </div>
  </li>
  <li>
    <p>Amount Paid - {{ student_bill.amount_paid|intcomma }}/-</p>
    <div class="progress" role="progressbar" aria-valuenow="{{ amount_paid_percentage }}" aria-valuemin="0" aria-valuemax="100" aria-label="Amount Paid Progress">
      <div class="progress-bar paid" style="width: {{ amount_paid_percentage }}%;"></div>
    </div>
  </li>
  <li>
    <p>Balance - {{ balance|intcomma }}/-</p>
    <div class="progress" role="progressbar" aria-valuenow="{{ balance_percentage }}" aria-valuemin="0" aria-valuemax="100" aria-label="Balance Progress">
      <div class="progress-bar balance" style="width: {{ balance_percentage }}%;"></div>
    </div>
  </li>
</ul>


            <button class="btn btn-info btn-block" onclick="printReceipt()">Print Receipt</button>
        </div>

        <div class="col-md-9 col-sm-9">
            <div class="profile_title">
                <div class="col-md-6">
                    <h2>Billed Items</h2>
                </div>
                {% if request.user.staff_account.role.name == "Bursar" %}
                    <div class="col-md-6">
                        <div id="add-bill-item" class="pull-right" style="margin-top: 5px;">
                            <a class="btn btn-success" data-toggle="modal" data-target=".bill-item-modal-lg">
                                <i class="fa fa-plus"></i> Add Bill Item
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>

          <div class="table-scroll-wrapper">
                <table class="data table table-striped no-margin">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Item</th>
                            <th>Description</th>
                            <th class="hidden-phone">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in student_bill.items.all %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ item.bill_item }}</td>
                                <td>{{ item.description }}</td>
                                <td class="hidden-phone">{{ item.amount|intcomma }}/-</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div role="tabpanel">
                <ul class="nav nav-tabs bar_tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#tab_content1" role="tab" data-toggle="tab" aria-expanded="true">Payment History</a></li>
                    <li role="presentation"><a href="#tab_content2" role="tab" data-toggle="tab" aria-expanded="false">Credits</a></li>
                    <li role="presentation"><a href="#tab_content3" role="tab" data-toggle="tab" aria-expanded="false">Discounts</a></li>
                    <li role="presentation"><a href="#tab_content4" role="tab" data-toggle="tab" aria-expanded="false">Documents</a></li>
                </ul>
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="tab_content1" aria-labelledby="home-tab">
                        {% if request.user.staff_account.role.name == "Bursar" %}
                            <div class="mb-3">
                                <a class="btn btn-success" data-toggle="modal" data-target=".payment-modal-lg">
                                    <i class="fa fa-plus"></i> Record New Payment
                                </a>
                            </div>
                        {% endif %}
                        <div class="x_content">
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Date</th>
                                        <th>Payment Mode</th>
                                        <th>Reference No</th>
                                        <th>Amount</th>
                                        <th>Recorded By</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in student_bill.payments.all %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                                            <td>{{ payment.payment_method }}</td>
                                            <td>{{ payment.reference_no }}</td>
                                            <td class="text-success"><strong>UGX {{ payment.amount|intcomma }}</strong></td>
                                            <td>{{ payment.recorded_by }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <i class="fa fa-info-circle fa-2x"></i>
                                                <br>No payments recorded yet
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                {% if student_bill.payments.all %}
                                <tfoot class="bg-light">
                                    <tr>
                                        <td colspan="4" class="font-weight-bold">TOTAL PAID</td>
                                        <td class="text-success font-weight-bold">UGX {{ student_bill.amount_paid|intcomma }}</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane fade" id="tab_content2" aria-labelledby="profile-tab">
                        <div class="x_content">
                            <div class="alert alert-info">
                                <i class="fa fa-info-circle"></i>
                                <strong>Credit System:</strong> Overpayments are automatically converted to credits for future bill payments.
                            </div>
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Credit Type</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Date Created</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="fa fa-gift fa-2x"></i>
                                            <br>Credit system is active and monitoring payments
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane fade" id="tab_content3" aria-labelledby="profile-tab">
                        <div class="x_content">
                            <div class="alert alert-warning">
                                <i class="fa fa-tags"></i>
                                <strong>Discount Information:</strong> Discount details and applied reductions will be displayed here.
                            </div>
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Discount Type</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Applied Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="fa fa-tags fa-2x"></i>
                                            <br>No discounts applied yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane fade" id="tab_content4" aria-labelledby="profile-tab">
                        <div class="x_content">
                            <div class="alert alert-secondary">
                                <i class="fa fa-file"></i>
                                <strong>Document Management:</strong> Student documents and certificates will be listed here.
                            </div>
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Document Type</th>
                                        <th>File Name</th>
                                        <th>Upload Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="fa fa-file fa-2x"></i>
                                            <br>No documents uploaded yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Professional Modals -->
<div class="modal fade bill-item-modal-lg no-print" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0; border: none;">
                <h5 class="modal-title">
                    <i class="fa fa-plus-circle"></i> Add New Bill Item
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" style="opacity: 0.8;">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{% url 'add_student_bill_item' student_bill.id %}">
                {% csrf_token %}
                <div class="modal-body" style="padding: 25px;">
                    {{ bill_item_form|crispy }}
                </div>
                <div class="modal-footer" style="border: none; padding: 20px 25px;">
                    <button type="button" class="btn btn-secondary btn-modern" data-dismiss="modal">
                        <i class="fa fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary btn-modern">
                        <i class="fa fa-save"></i> Add Bill Item
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade payment-modal-lg no-print" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border-radius: 12px 12px 0 0; border: none;">
                <h5 class="modal-title">
                    <i class="fa fa-credit-card"></i> Record New Payment
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" style="opacity: 0.8;">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{% url 'record_payment' student_bill.id %}">
                {% csrf_token %}
                <div class="modal-body" style="padding: 25px;">
                    {{ payment_form|crispy }}
                </div>
                <div class="modal-footer" style="border: none; padding: 20px 25px;">
                    <button type="button" class="btn btn-secondary btn-modern" data-dismiss="modal">
                        <i class="fa fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-success btn-modern">
                        <i class="fa fa-check"></i> Record Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Professional Printable Receipt -->
<div id="printableReceipt" style="display:none; font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
    <!-- Header -->
    <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px;">
        <h1 style="color: #333; margin: 0; font-size: 28px;">STUDENT PAYMENT RECEIPT</h1>
        <p style="color: #666; margin: 5px 0; font-size: 14px;">{{ school_name|default:"School Management System" }}</p>
        <p style="color: #666; margin: 5px 0; font-size: 12px;">Generated on {{ now|date:"F d, Y" }}</p>
    </div>

    <!-- Student Information -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
        <h3 style="color: #333; margin-top: 0; border-bottom: 1px solid #dee2e6; padding-bottom: 10px;">Student Information</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="padding: 8px 0; font-weight: bold; width: 150px;">Student Name:</td>
                <td style="padding: 8px 0;">{{ student_bill.student.student_name }}</td>
            </tr>
            <tr style="background: #fff;">
                <td style="padding: 8px 0; font-weight: bold;">Registration No:</td>
                <td style="padding: 8px 0;">{{ student_bill.student.reg_no }}</td>
            </tr>
            <tr>
                <td style="padding: 8px 0; font-weight: bold;">Class:</td>
                <td style="padding: 8px 0;">{{ student_bill.student.current_class.code }}</td>
            </tr>
            <tr style="background: #fff;">
                <td style="padding: 8px 0; font-weight: bold;">Stream:</td>
                <td style="padding: 8px 0;">{{ student_bill.student.stream }}</td>
            </tr>
            <tr>
                <td style="padding: 8px 0; font-weight: bold;">Academic Year:</td>
                <td style="padding: 8px 0;">{{ student_bill.academic_class.academic_year }}</td>
            </tr>
            <tr style="background: #fff;">
                <td style="padding: 8px 0; font-weight: bold;">Term:</td>
                <td style="padding: 8px 0;">{{ student_bill.academic_class.term }}</td>
            </tr>
        </table>
    </div>

    <!-- Billed Items -->
    <div style="margin-bottom: 25px;">
        <h3 style="color: #333; border-bottom: 1px solid #dee2e6; padding-bottom: 10px;">Billed Items</h3>
        <table style="width: 100%; border-collapse: collapse; border: 1px solid #dee2e6;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">#</th>
                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Item</th>
                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: bold;">Description</th>
                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-weight: bold;">Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for item in student_bill.items.all %}
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 10px;">{{ forloop.counter }}</td>
                    <td style="border: 1px solid #dee2e6; padding: 10px;">{{ item.bill_item.item_name }}</td>
                    <td style="border: 1px solid #dee2e6; padding: 10px;">{{ item.description }}</td>
                    <td style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">UGX {{ item.amount|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="background: #f8f9fa; font-weight: bold;">
                    <td colspan="3" style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">TOTAL AMOUNT:</td>
                    <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">UGX {{ student_bill.total_amount|intcomma }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Payment Summary -->
    <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
        <h3 style="color: #333; margin-top: 0; border-bottom: 1px solid #dee2e6; padding-bottom: 10px;">Payment Summary</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="padding: 10px 0; font-weight: bold; width: 200px;">Total Amount:</td>
                <td style="padding: 10px 0;">UGX {{ student_bill.total_amount|intcomma }}</td>
            </tr>
            <tr style="background: #f8f9fa;">
                <td style="padding: 10px 0; font-weight: bold;">Amount Paid:</td>
                <td style="padding: 10px 0; color: #28a745; font-weight: bold;">UGX {{ student_bill.amount_paid|intcomma }}</td>
            </tr>
            <tr>
                <td style="padding: 10px 0; font-weight: bold;">Outstanding Balance:</td>
                <td style="padding: 10px 0; color: {% if balance > 0 %}#dc3545{% else %}#28a745{% endif %}; font-weight: bold;">
                    UGX {{ balance|intcomma }}
                </td>
            </tr>
        </table>
    </div>

    <!-- Payment History -->
    {% if student_bill.payments.all %}
    <div style="margin-bottom: 25px;">
        <h3 style="color: #333; border-bottom: 1px solid #dee2e6; padding-bottom: 10px;">Payment History</h3>
        <table style="width: 100%; border-collapse: collapse; border: 1px solid #dee2e6;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left; font-weight: bold;">#</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left; font-weight: bold;">Date</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left; font-weight: bold;">Payment Method</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left; font-weight: bold;">Reference No</th>
                    <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right; font-weight: bold;">Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in student_bill.payments.all %}
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">{{ forloop.counter }}</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">{{ payment.payment_date|date:"M d, Y" }}</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">{{ payment.payment_method }}</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">{{ payment.reference_no }}</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">UGX {{ payment.amount|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Footer -->
    <div style="border-top: 1px solid #dee2e6; padding-top: 20px; margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
        <p>This is a computer-generated receipt. No signature required.</p>
        <p>For any queries, please contact the school administration.</p>
    </div>
</div>


<script>
// Simple Print Function
function printReceipt() {
    const receipt = document.getElementById("printableReceipt").innerHTML;
    const printWindow = window.open('', '_blank', 'height=800,width=1000,scrollbars=yes');

    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Student Payment Receipt - {{ student_bill.student.student_name }}</title>
            <meta charset="utf-8">
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                    color: #333;
                    line-height: 1.6;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 20px;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 10px;
                    text-align: left;
                }
                th {
                    background-color: #f5f5f5;
                    font-weight: bold;
                }
                .header-section {
                    text-align: center;
                    border-bottom: 2px solid #333;
                    padding-bottom: 20px;
                    margin-bottom: 20px;
                }
                .summary-section {
                    background: #f9f9f9;
                    padding: 15px;
                    border-radius: 5px;
                    margin: 15px 0;
                }
                .footer-section {
                    border-top: 1px solid #ddd;
                    padding-top: 15px;
                    margin-top: 20px;
                    text-align: center;
                    color: #666;
                    font-size: 11px;
                }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
    `);

    printWindow.document.write(receipt);
    printWindow.document.write(`
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.focus();

    setTimeout(function() {
        printWindow.print();
        printWindow.close();
    }, 500);
}

// Basic modal focus
$(document).ready(function() {
    $('.modal').on('shown.bs.modal', function() {
        $(this).find('input:first').focus();
    });
});
</script>
{% endblock %}