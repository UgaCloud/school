{% extends "../base.html" %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block page_title %}Academic Classes Management{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Page Header -->
  <div class="row">
    <div class="col-md-12">
      <div class="x_panel">
        <div class="x_title d-flex align-items-center justify-content-between">
          <h2 class="mb-0">
            <i class="fa fa-university mr-2"></i> Academic Classes
            <small class="text-muted d-block" style="font-size:.9rem;">Manage and organize your academic classes efficiently</small>
          </h2>
          <div class="btn-group">
            {% if user.staff_account.role.name == "Admin" %}
              <a href="{% url 'class_bill_list' %}" class="btn btn-default btn-sm">
                <i class="fa fa-file-invoice-dollar"></i> Class Bills
              </a>
              <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addClassModal">
                <i class="fa fa-plus-circle"></i> New Class
              </button>
            {% endif %}
          </div>
          <div class="clearfix"></div>
        </div>

        {% if academic_classes %}
        <div class="x_content">
          <div class="row tile_count">
            <div class="col-md-3 col-sm-3 col-xs-6 tile_stats_count">
              <span class="count_top"><i class="fa fa-graduation-cap"></i> Total Classes</span>
              <div class="count">{{ total_classes }}</div>
            </div>
            <div class="col-md-3 col-sm-3 col-xs-6 tile_stats_count">
              <span class="count_top"><i class="fa fa-calendar"></i> Active Terms</span>
              <div class="count">{{ distinct_terms }}</div>
            </div>
            <div class="col-md-3 col-sm-3 col-xs-6 tile_stats_count">
              <span class="count_top"><i class="fa fa-calendar-o"></i> Academic Years</span>
              <div class="count">{{ academic_years_count }}</div>
            </div>
            <div class="col-md-3 col-sm-3 col-xs-6 tile_stats_count">
              <span class="count_top"><i class="fa fa-university"></i> Sections</span>
              <div class="count">{{ distinct_sections }}</div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="row">
    <div class="col-md-12">
      <div class="x_panel">
        <div class="x_title d-flex align-items-center justify-content-between">
          <h2 class="mb-0"><i class="fa fa-filter"></i> Advanced Filters</h2>
          <ul class="nav navbar-right panel_toolbox">
            <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
          </ul>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">
          <form method="get" id="filter-form" class="form-horizontal">
            <div class="row">
              <div class="col-md-3 col-sm-6">
                <div class="form-group">
                  <label class="control-label" for="academic_year">Academic Year</label>
                  <select class="form-control" name="academic_year" id="academic_year" onchange="document.getElementById('filter-form').submit()">
                    <option value="">All Academic Years</option>
                    {% for year in academic_years %}
                      <option value="{{ year.id }}" {% if current_academic_year == year.id|stringformat:"s" %}selected{% endif %}>
                        {{ year.academic_year }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div class="col-md-3 col-sm-6">
                <div class="form-group">
                  <label class="control-label" for="term">Term</label>
                  <select class="form-control" name="term" id="term" onchange="document.getElementById('filter-form').submit()">
                    <option value="">All Terms</option>
                    {% for term in all_terms %}
                      <option value="{{ term.id }}" {% if current_term == term.id|stringformat:"s" %}selected{% endif %}>
                        {{ term.term }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div class="col-md-3 col-sm-6">
                <div class="form-group">
                  <label class="control-label" for="class_filter">Class</label>
                  <select class="form-control" name="class" id="class_filter" onchange="document.getElementById('filter-form').submit()">
                    <option value="">All Classes</option>
                    {% for class_option in classes %}
                      <option value="{{ class_option.id }}" {% if current_class == class_option.id|stringformat:"s" %}selected{% endif %}>
                        {{ class_option.name|default:class_option.code }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div class="col-md-3 col-sm-6">
                <div class="form-group">
                  <label class="control-label" for="section_filter">Section</label>
                  <select class="form-control" name="section" id="section_filter" onchange="document.getElementById('filter-form').submit()">
                    <option value="">All Sections</option>
                    {% for section_option in sections_list %}
                      <option value="{{ section_option.id }}" {% if current_section == section_option.id|stringformat:"s" or current_section == section_option %}selected{% endif %}>
                        {{ section_option.section_name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>

            <!-- Active filter chips -->
            <div class="row">
              <div class="col-md-12">
                <div class="filter-chips">
                  {% if current_academic_year %}
                    <span class="badge badge-default"><i class="fa fa-calendar"></i> Year: 
                      {% for y in academic_years %}{% if y.id|stringformat:"s" == current_academic_year %}{{ y.academic_year }}{% endif %}{% endfor %}
                    </span>
                  {% endif %}
                  {% if current_term %}
                    <span class="badge badge-info"><i class="fa fa-clock-o"></i> Term: 
                      {% for t in all_terms %}{% if t.id|stringformat:"s" == current_term %}{{ t.term }}{% endif %}{% endfor %}
                    </span>
                  {% endif %}
                  {% if current_class %}
                    <span class="badge badge-primary"><i class="fa fa-graduation-cap"></i> Class: 
                      {% for c in classes %}{% if c.id|stringformat:"s" == current_class %}{{ c.name|default:c.code }}{% endif %}{% endfor %}
                    </span>
                  {% endif %}
                  {% if current_section %}
                    <span class="badge badge-success"><i class="fa fa-university"></i> Section: 
                      {% for s in sections_list %}{% if s.id|stringformat:"s" == current_section %}{{ s.section_name }}{% endif %}{% endfor %}
                    </span>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="text-right mt-10">
              <a href="{% url 'academic_class_page' %}" class="btn btn-default"><i class="fa fa-undo"></i> Reset</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Classes: View Toggle + Table / Cards -->
  <div class="row">
    <div class="col-md-12">
      <div class="x_panel">
        <div class="x_title d-flex align-items-center justify-content-between">
          <h2 class="mb-0"><i class="fa fa-list"></i> Classes</h2>
          <div class="d-flex align-items-center">
          
            <div class="btn-group" role="group" aria-label="ViewToggle">
              <button id="tableViewBtn" type="button" class="btn btn-default btn-sm active"><i class="fa fa-table"></i> Table</button>
              <button id="cardsViewBtn" type="button" class="btn btn-default btn-sm"><i class="fa fa-th-large"></i> Cards</button>
            </div>
          </div>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">

          {% if academic_classes %}
            <!-- Table View -->
            <div id="classesTableWrap">
              <table id="classesTable" class="table table-striped table-bordered datatable" style="width:100%">
                <thead>
                  <tr>
                    <th>Class</th>
                    <th>Term</th>
                    <th>Academic Year</th>
                    <th>Section</th>
                    {% if user.staff_account.role.name == "Admin" %}<th>Fees Amount</th>{% endif %}
                    <th>Streams</th>
                    <th>Status</th>
                    <th style="min-width:150px;">Actions</th>
                  </tr>
                  <!-- Per-column filters row (inserted by JS) -->
                </thead>
                <tbody>
                  {% for academic_class in academic_classes %}
                  <tr>
                    <td><strong>{{ academic_class.Class.name|default:academic_class.Class.code }}</strong></td>
                    <td><span class="label label-info">{{ academic_class.term.term }}</span></td>
                    <td><span class="label label-default">{{ academic_class.academic_year.academic_year }}</span></td>
                    <td><span class="label label-primary">{{ academic_class.section }}</span></td>
                    {% if user.staff_account.role.name == "Admin" %}
                      <td>UGX {{ academic_class.fees_amount|intcomma }}</td>
                    {% endif %}
                    <td>
                      {% with academic_class.classstreams.all as streams %}
                        <span class="badge bg-green">{{ streams|length }}</span>
                      {% endwith %}
                    </td>
                    <td>
                      {% if academic_class.term.is_current %}
                        <span class="label label-success">Active</span>
                      {% else %}
                        <span class="label label-default">Inactive</span>
                      {% endif %}
                    </td>
                    <td class="text-nowrap">
                      <div class="btn-group btn-group-sm">
                        <a class="btn btn-primary" href="{% url 'academic_class_details_page' academic_class.id %}" title="Details">
                          <i class="fa fa-eye"></i>
                        </a>
                        {% if user.staff_account.role.name == "Admin" %}
                        <a class="btn btn-success" href="{% url 'edit_academic_class_details_page' academic_class.id %}" title="Edit">
                          <i class="fa fa-edit"></i>
                        </a>
                        <a class="btn btn-default" href="{% url 'add_class_bill_items' academic_class.id %}" title="Add Bill Item">
                          <i class="fa fa-file-invoice-dollar"></i>
                        </a>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Cards View -->
            <div id="classesCards" class="row" style="display:none;">
              {% for academic_class in academic_classes %}
                <div class="col-lg-3 col-md-4 col-sm-6">
                  <div class="x_panel" style="position:relative; overflow:hidden;">
                    {% if academic_class.term.is_current %}
                      <span class="status-ribbon ribbon-success">Active</span>
                    {% else %}
                      <span class="status-ribbon ribbon-default">Inactive</span>
                    {% endif %}
                    <div class="x_title">
                      <h2 class="mb-0">
                        <i class="fa fa-graduation-cap"></i>
                        {{ academic_class.Class.name|default:academic_class.Class.code }}
                      </h2>
                      <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                      <ul class="list-unstyled project_files">
                        <li><i class="fa fa-clock-o"></i> Term: <strong>{{ academic_class.term.term }}</strong></li>
                        <li><i class="fa fa-calendar-o"></i> Year: <strong>{{ academic_class.academic_year.academic_year }}</strong></li>
                        <li><i class="fa fa-university"></i> Section: <strong>{{ academic_class.section }}</strong></li>
                        {% if user.staff_account.role.name == "Admin" %}
                        <li><i class="fa fa-money"></i> Fees: <strong>UGX {{ academic_class.fees_amount|intcomma }}</strong></li>
                        {% endif %}
                        <li><i class="fa fa-stream"></i> Streams: 
                          {% with academic_class.classstreams.all as streams %}
                            <span class="badge bg-green">{{ streams|length }}</span>
                          {% endwith %}
                        </li>
                      </ul>
                      <div class="btn-group btn-group-sm d-flex">
                        <a class="btn btn-primary" href="{% url 'academic_class_details_page' academic_class.id %}" title="Details">
                          <i class="fa fa-eye"></i> Details
                        </a>
                        {% if user.staff_account.role.name == "Admin" %}
                        <a class="btn btn-success" href="{% url 'edit_academic_class_details_page' academic_class.id %}" title="Edit">
                          <i class="fa fa-edit"></i> Edit
                        </a>
                        <a class="btn btn-default" href="{% url 'add_class_bill_items' academic_class.id %}" title="Add Bill Item">
                          <i class="fa fa-file-invoice-dollar"></i> Bills
                        </a>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>

          {% else %}
            <div class="alert alert-info">
              <i class="fa fa-info-circle"></i> No Academic Classes found. Use the New Class button above to create a class.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

{% if user.staff_account.role.name == "Admin" %}
<!-- Add Class Modal -->
<div class="modal fade" id="addClassModal" tabindex="-1" role="dialog" aria-labelledby="addClassModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="addClassModalLabel"><i class="fa fa-plus-circle"></i> Add New Academic Class</h4>
      </div>
      <form method="POST">
        {% csrf_token %}
        <div class="modal-body">
          {{ form|crispy }}
          <p class="text-muted"><small>Ensure Term, Academic Year, Section and Fees are correct to keep billing consistent.</small></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Create Class</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<style>
  #classesTable th, #classesTable td { vertical-align: middle; }
  .btn-group .btn { min-width: 34px; }
  .filter-chips .badge { margin-right: .35rem; padding: .45em .6em; font-weight: 600; }

  /* Ribbon status for cards */
  .status-ribbon {
    position: absolute;
    right: -40px;
    top: 12px;
    transform: rotate(45deg);
    color: #fff;
    padding: 6px 50px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: .08em;
  }
  .ribbon-success { background: #26B99A; }
  .ribbon-default { background: #9e9e9e; }
</style>

<script>
  (function(){
    function toggleView(showTable) {
      var $tableWrap = $('#classesTableWrap');
      var $cardsWrap = $('#classesCards');
      if (showTable) {
        $tableWrap.show();
        $cardsWrap.hide();
        $('#tableViewBtn').addClass('active');
        $('#cardsViewBtn').removeClass('active');
      } else {
        $tableWrap.hide();
        $cardsWrap.show();
        $('#tableViewBtn').removeClass('active');
        $('#cardsViewBtn').addClass('active');
      }
    }

    $(document).ready(function() {
      // Toggle view handlers
      $('#tableViewBtn').on('click', function(e){ e.preventDefault(); toggleView(true); });
      $('#cardsViewBtn').on('click', function(e){ e.preventDefault(); toggleView(false); });

      // Hook into DataTables that is initialized globally in base.html for .datatable
      var tryInitEnhancements = function() {
        var $tableEl = $('#classesTable');
        if (!$tableEl.length) return;

        var dt;
        if ($.fn.dataTable.isDataTable($tableEl)) {
          dt = $tableEl.DataTable();
        } else {
          // fallback if global init hasn't run yet
          dt = $tableEl.DataTable({
            responsive: true,
            paging: true,
            searching: true,
            ordering: true,
            pageLength: 10,
            dom: 'lBfrtip',
            buttons: ['csv', 'pdf', 'print']
          });
        }

        // Wire export buttons
        $('#exportCsvBtn').off('click').on('click', function(e){ e.preventDefault(); dt.button('.buttons-csv').trigger(); });
        $('#exportPdfBtn').off('click').on('click', function(e){ e.preventDefault(); dt.button('.buttons-pdf').trigger(); });
        $('#printBtn').off('click').on('click', function(e){ e.preventDefault(); dt.button('.buttons-print').trigger(); });

        // Add per-column filters (second header row)
        if ($('#classesTable thead tr.filters').length === 0) {
          var $filterRow = $('<tr class="filters"></tr>');
          $('#classesTable thead tr:first th').each(function(index){
            var heading = $(this).text().trim().toLowerCase();
            if (heading === 'actions' || heading === 'fees amount') {
              $filterRow.append('<th></th>');
              return;
            }
            if (heading === 'status') {
              var html = '<select class="form-control input-sm"><option value="">All</option><option value="Active">Active</option><option value="Inactive">Inactive</option></select>';
              $filterRow.append('<th>'+ html +'</th>');
            } else {
              $filterRow.append('<th><input type="text" class="form-control input-sm" placeholder="Search '+ ($(this).text().trim() || '') +'"></th>');
            }
          });
          $('#classesTable thead').append($filterRow);

          // Bind change events
          $('#classesTable thead tr.filters th').each(function(i){
            var node = $(this).find('input,select');
            if (!node.length) return;
            $(node).on('keyup change', function(){
              var val = $(this).val();
              dt.column(i).search(val ? val : '', true, false).draw();
            });
          });
        }
      };

      // Run once after a small delay to ensure global init completed
      setTimeout(tryInitEnhancements, 150);

    });
  })();
</script>
{% endblock %}
