{% extends "./base.html" %}
{% load static %}
{% load humanize %}

{% block page_title %}School Management Dashboard{% endblock %}

{% block content %}
<div class="clearfix"></div>

<div class="row">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-tachometer"></i> Dashboard Overview</h2>
        <ul class="nav navbar-right panel_toolbox">
          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
        </ul>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="row">
          <div class="col-sm-8 col-xs-12">
            <p class="text-muted">Welcome back, <strong>{{ user.get_full_name|default:user.username }}</strong>
            {% if current_year and current_term %}
              <span class="label label-info" style="margin-left:6px;">Term {{ current_term.term }} {{ current_year.academic_year }}</span>
            {% endif %}
            </p>
          </div>
          <div class="col-sm-4 col-xs-12 text-right">
            <div class="btn-group">
              {% if is_academic %}
              <a href="{% url 'add_student' %}" class="btn btn-primary btn-sm"><i class="fa fa-user-plus"></i> Add Student</a>
              {% endif %}
              {% if is_admin %}
              <a href="{% url 'add_staff' %}" class="btn btn-success btn-sm"><i class="fa fa-user"></i> Add Staff</a>
              {% endif %}
              {% if is_finance %}
              <a href="{% url 'bill_item_page' %}" class="btn btn-warning btn-sm"><i class="fa fa-money"></i> Create Bill</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- KPI Tiles -->
<div class="row tile_count">
  {% if not is_support %}
  <div class="col-md-3 col-sm-4 col-xs-6 tile_stats_count">
    <span class="count_top"><i class="fa fa-users"></i> Total Staff</span>
    <div class="count">{{ total_staff|default:0 }}</div>
    <span class="count_bottom"><i class="green"><i class="fa fa-level-up"></i></i> Active members</span>
  </div>
  {% endif %}
  {% if is_academic %}
  <div class="col-md-3 col-sm-4 col-xs-6 tile_stats_count">
    <span class="count_top"><i class="fa fa-graduation-cap"></i> Total Students</span>
    <div class="count">{{ total_students|default:0 }}</div>
    <span class="count_bottom"><i class="blue"><i class="fa fa-info-circle"></i></i> Enrolled</span>
  </div>
  <div class="col-md-3 col-sm-4 col-xs-6 tile_stats_count">
    <span class="count_top"><i class="fa fa-university"></i> Active Classes</span>
    <div class="count">{{ active_classes|default:0 }}</div>
    <span class="count_bottom"><i class="blue"><i class="fa fa-info-circle"></i></i> Running</span>
  </div>
  {% endif %}
  {% if is_finance %}
  <div class="col-md-3 col-sm-4 col-xs-6 tile_stats_count">
    <span class="count_top"><i class="fa fa-exclamation-triangle"></i> Pending Tasks</span>
    <div class="count">{{ pending_tasks|default:0 }}</div>
    <span class="count_bottom"><i class="orange"><i class="fa fa-clock-o"></i></i> Requires attention</span>
  </div>
  {% endif %}
</div>

{% if is_academic or is_finance %}
<div class="row">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-bar-chart"></i> Performance Metrics</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="row">
          {% if is_academic %}
          <div class="col-md-4 col-sm-6 col-xs-12">
            <div class="dashboard-widget-content">
              <h4 class="title">Assessment Completion</h4>
              <div class="row">
                <div class="col-xs-12">
                  <h2 class="text-primary">{{ assessment_completion_rate|default:0 }}%</h2>
                  <div class="progress progress_sm">
                    <div class="progress-bar bg-blue" role="progressbar" data-transitiongoal="{{ assessment_completion_rate|default:0 }}"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          {% if is_finance %}
          <div class="col-md-4 col-sm-6 col-xs-12">
            <div class="dashboard-widget-content">
              <h4 class="title">Fee Collection Rate</h4>
              <div class="row">
                <div class="col-xs-12">
                  <h2 class="green">{{ fee_collection_rate|default:0 }}%</h2>
                  <div class="progress progress_sm">
                    <div class="progress-bar bg-green" role="progressbar" data-transitiongoal="{{ fee_collection_rate|default:0 }}"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          {% if is_academic %}
          <div class="col-md-4 col-sm-6 col-xs-12">
            <div class="dashboard-widget-content">
              <h4 class="title">Total Subjects</h4>
              <h2 class="text-info">{{ total_subjects|default:0 }}</h2>
              <p class="text-muted">Active curriculum subjects</p>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if is_finance %}
<div class="row">
  <div class="col-md-6 col-sm-6 col-xs-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-money"></i> Financial Summary</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="row">
          <div class="col-xs-6 text-center">
            <div class="well" style="margin-bottom:10px;">
              <h4 class="green">UGX {{ total_fees_collected|intcomma }}</h4>
              <small class="text-muted">Fees Collected</small>
            </div>
          </div>
          <div class="col-xs-6 text-center">
            <div class="well" style="margin-bottom:10px;">
              <h4 class="red">UGX {{ total_fees_outstanding|intcomma }}</h4>
              <small class="text-muted">Outstanding</small>
            </div>
          </div>
        </div>
        <hr/>
        <div class="row text-center">
          <div class="col-xs-4">
            <span class="label label-success">{{ paid_bills }}</span>
            <p class="text-muted small">Paid</p>
          </div>
          <div class="col-xs-4">
            <span class="label label-warning">{{ unpaid_bills }}</span>
            <p class="text-muted small">Pending</p>
          </div>
          <div class="col-xs-4">
            <span class="label label-danger">{{ overdue_bills }}</span>
            <p class="text-muted small">Overdue</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-sm-6 col-xs-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-pie-chart"></i> Budget Overview</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="text-center">
          <h4 class="text-primary">UGX {{ budget_allocated|intcomma }}</h4>
          <small class="text-muted">Total Budget</small>
        </div>
        <div class="progress progress_sm" style="margin-top:10px;">
          <div class="progress-bar bg-green" role="progressbar" data-transitiongoal="{% widthratio budget_spent|default:0 budget_allocated|default:1 100 %}"></div>
        </div>
        <div class="row" style="margin-top:10px;">
          <div class="col-xs-6 text-center">
            <div class="well" style="margin-bottom:10px;">
              <h5 class="green">UGX {{ budget_spent|intcomma }}</h5>
              <small class="text-muted">Spent</small>
            </div>
          </div>
          <div class="col-xs-6 text-center">
            <div class="well" style="margin-bottom:10px;">
              <h5 class="blue">UGX {{ budget_remaining|intcomma }}</h5>
              <small class="text-muted">Remaining</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="col-md-6 col-sm-6 col-xs-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-tasks"></i> Quick Actions</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="row">
          {% if is_academic %}
          <div class="col-xs-12" style="margin-bottom:8px;">
            <a href="{% url 'add_student' %}" class="btn btn-primary btn-block"><i class="fa fa-user-plus"></i> Add Student</a>
          </div>
          {% endif %}
          {% if is_admin %}
          <div class="col-xs-12" style="margin-bottom:8px;">
            <a href="{% url 'add_staff' %}" class="btn btn-success btn-block"><i class="fa fa-user"></i> Add Staff</a>
          </div>
          {% endif %}
          {% if is_finance %}
          <div class="col-xs-12" style="margin-bottom:8px;">
            <a href="{% url 'bill_item_page' %}" class="btn btn-warning btn-block"><i class="fa fa-money"></i> Create Bill</a>
          </div>
          {% endif %}
          {% if is_academic %}
          <div class="col-xs-12">
            <a href="{% url 'student_page' %}" class="btn btn-info btn-block"><i class="fa fa-search"></i> Search Students</a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-sm-6 col-xs-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-clock-o"></i> Recent Activities</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        {% if is_finance and recent_payments %}
        <ul class="list-unstyled timeline">
          {% for payment in recent_payments %}
          <li>
            <div class="block">
              <div class="tags">
                <a class="tag"><span class="green">Payment</span></a>
              </div>
              <div class="block_content">
                <h2 class="title">{{ payment.bill.student.student_name }}</h2>
                <div class="byline">UGX {{ payment.amount|intcomma }} • {{ payment.payment_date|date:"M d, Y" }}</div>
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
        {% elif is_academic and recent_registrations %}
        <ul class="list-unstyled timeline">
          {% for student in recent_registrations %}
          <li>
            <div class="block">
              <div class="tags">
                <a class="tag"><span class="blue">Student</span></a>
              </div>
              <div class="block_content">
                <h2 class="title">{{ student.student_name }}</h2>
                <div class="byline">{{ student.current_class.name }} • Reg: {{ student.reg_no }}</div>
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="text-center">
          <i class="fa fa-inbox fa-3x text-muted" style="margin-bottom:8px;"></i>
          <h6 class="text-muted">No Recent Activities</h6>
          <small class="text-muted">Recent activities will appear here</small>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if is_academic and class_distribution %}
<div class="row">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-bar-chart"></i> Class Distribution</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="row">
          {% for class_data in class_distribution %}
          <div class="col-md-2 col-sm-3 col-xs-6">
            <div class="well" style="text-align:center; margin-bottom:10px;">
              <h5 class="text-info" style="margin:0 0 4px;">{{ class_data.current_class__name }}</h5>
              <h3 style="margin:0;">{{ class_data.count }}</h3>
              <small class="text-muted">Students</small>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

<!-- Minimal dashboard-specific styles to complement Gentelella -->
<style>
.dashboard-widget-content .title{font-weight:600;margin-bottom:8px;}
.progress_sm{height:10px;margin-bottom:10px;}
.green{color:#1ABB9C;}
.blue{color:#3498DB;}
.red{color:#E74C3C;}
.text-primary{color:#3498DB;}
.text-info{color:#17a2b8;}
</style>