{% extends "../base.html" %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block page_title %}Income Statement{% endblock %}

{% block content %}
<div class="clearfix"></div>

<div class="row">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-balance-scale"></i> Income Statement</h2>
        <ul class="nav navbar-right panel_toolbox">
          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
          <li><a class="print-link" onclick="window.print()" title="Print Report"><i class="fa fa-print"></i></a></li>
          <li>
            <a href="?{% if start_date %}start_date={{ start_date }}&{% endif %}{% if end_date %}end_date={{ end_date }}&{% endif %}export=csv" title="Export to CSV">
              <i class="fa fa-file-excel-o"></i>
            </a>
          </li>
        </ul>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">

        <!-- Filters -->
        <div class="row" style="margin-bottom: 15px;">
          <div class="col-md-12">
            <form method="get" class="form-inline">
              <div class="form-group">
                <label for="start_date"><strong>Start Date:</strong></label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date|default:'' }}" style="margin-left: 10px;">
              </div>
              <div class="form-group" style="margin-left: 20px;">
                <label for="end_date"><strong>End Date:</strong></label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date|default:'' }}" style="margin-left: 10px;">
              </div>
              <div class="form-group" style="margin-left: 20px;">
                <label for="mode"><strong>Basis:</strong></label>
                <select id="mode" name="mode" class="form-control" style="margin-left: 10px; min-width: 140px;">
                  <option value="accrual" {% if mode == 'accrual' %}selected{% endif %}>Accrual</option>
                  <option value="cash" {% if mode == 'cash' %}selected{% endif %}>Cash</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary" style="margin-left: 20px;">
                <i class="fa fa-refresh"></i> Apply
              </button>
              <a href="?{% if start_date %}start_date={{ start_date }}&{% endif %}{% if end_date %}end_date={{ end_date }}&{% endif %}mode={{ mode }}&export=csv" class="btn btn-success" style="margin-left: 10px;">
                <i class="fa fa-download"></i> Export CSV
              </a>
            </form>
          </div>
        </div>

        <!-- Active range notice -->
        {% if used_term_default %}
        <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
          Using current term by default:
          <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong>.
          Included rows: {{ income_tx|length }} income, {{ expense_tx|length }} expense. | Basis: <strong>{{ mode|title }}</strong>
        </div>
        {% else %}
        <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
          Showing transactions from <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong>.
          Included rows: {{ income_tx|length }} income, {{ expense_tx|length }} expense. | Basis: <strong>{{ mode|title }}</strong>
        </div>
        {% endif %}

        <!-- Sample rows -->
        <div class="row" style="margin-bottom: 10px;">
          <div class="col-md-6">
            <small><strong>Sample income (first {{ sample_income|length }}):</strong></small>
            {% if sample_income %}
            <ul class="list-unstyled" style="margin-bottom: 0;">
              {% for t in sample_income %}
              <li><small>{{ t.date|date:"Y-m-d" }} — {{ t.description }} — UGX {{ t.amount|floatformat:0|intcomma }}</small></li>
              {% endfor %}
            </ul>
            {% else %}
            <small>No income in range.</small>
            {% endif %}
          </div>
          <div class="col-md-6">
            <small><strong>Sample expenses (first {{ sample_expense|length }}):</strong></small>
            {% if sample_expense %}
            <ul class="list-unstyled" style="margin-bottom: 0;">
              {% for t in sample_expense %}
              <li><small>{{ t.date|date:"Y-m-d" }} — {{ t.description }} — UGX {{ t.amount|floatformat:0|intcomma }}</small></li>
              {% endfor %}
            </ul>
            {% else %}
            <small>No expenses in range.</small>
            {% endif %}
          </div>
        </div>
        <!-- Summary Cards -->
        <div class="row" style="margin-bottom: 20px;">
          <div class="col-md-4">
            <div class="card" style="border-left: 4px solid #28a745; background-color: #f8f9fa;">
              <div class="card-body text-center">
                <h5>Total Income</h5>
                <h3 class="text-success">UGX {{ total_income|floatformat:0|intcomma }}</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card" style="border-left: 4px solid #d9534f; background-color: #f8f9fa;">
              <div class="card-body text-center">
                <h5>Total Expenses</h5>
                <h3 class="text-danger">UGX {{ total_expense|floatformat:0|intcomma }}</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card" style="border-left: 4px solid #337ab7; background-color: #f8f9fa;">
              <div class="card-body text-center">
                <h5>Net Income</h5>
                <h3 class="{% if net_income >= 0 %}text-success{% else %}text-danger{% endif %}">
                  UGX {{ net_income|floatformat:0|intcomma }}
                </h3>
              </div>
            </div>
          </div>
        </div>

        <!-- Income by Source -->
        <div class="row">
          <div class="col-md-12">
            <h3><i class="fa fa-list"></i> Income by Source</h3>
            {% if income_breakdown %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                  <tr>
                    <th>Source</th>
                    <th>Amount (UGX)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in income_breakdown %}
                  <tr>
                    <td><strong>{{ row.source }}</strong></td>
                    <td>UGX {{ row.total|floatformat:0|intcomma }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr style="font-weight: bold; background-color: #f8f9fa;">
                    <td>TOTAL</td>
                    <td>UGX {{ total_income|floatformat:0|intcomma }}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            {% else %}
              <div class="alert alert-info">No income found for the selected period.</div>
            {% endif %}
          </div>
        </div>

        <!-- Detailed Transactions -->
        <div class="row" style="margin-top: 30px;">
          <div class="col-md-6">
            <h3><i class="fa fa-arrow-down"></i> Income Transactions</h3>
            {% if income_tx %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Source</th>
                    <th>Amount (UGX)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in income_tx %}
                  <tr>
                    <td><small>{{ t.date|date:"Y-m-d" }}</small></td>
                    <td><small>{{ t.description }}</small></td>
                    <td><small>{% if t.related_income_source %}{{ t.related_income_source.name }}{% else %}Unspecified{% endif %}</small></td>
                    <td><span class="badge bg-green">UGX {{ t.amount|floatformat:0|intcomma }}</span></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
              <div class="alert alert-info">No income transactions found.</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <h3><i class="fa fa-arrow-up"></i> Expense Transactions</h3>
            {% if expense_tx %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount (UGX)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in expense_tx %}
                  <tr>
                    <td><small>{{ t.date|date:"Y-m-d" }}</small></td>
                    <td><small>{{ t.description }}</small></td>
                    <td><span class="badge bg-red">UGX {{ t.amount|floatformat:0|intcomma }}</span></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
              <div class="alert alert-info">No expense transactions found.</div>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
.badge.bg-green {
  background-color: #27ae60;
  padding: 4px 8px;
  border-radius: 15px;
  font-size: 13px;
  color: white;
}
.badge.bg-red {
  background-color: #e74c3c;
  padding: 4px 8px;
  border-radius: 15px;
  font-size: 13px;
  color: white;
}
</style>
{% endblock %}