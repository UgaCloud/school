{% extends "../base.html" %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block page_title %}Cash Flow Report{% endblock %}

{% block content %}
<div class="clearfix"></div>

<div class="row">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-exchange"></i> Cash Flow Report</h2>
        <ul class="nav navbar-right panel_toolbox">
          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
          <li><a class="print-link" onclick="window.print()" title="Print Report"><i class="fa fa-print"></i></a></li>
          <li>
            <a href="?{% if start_date %}start_date={{ start_date }}&{% endif %}{% if end_date %}end_date={{ end_date }}&{% endif %}export=csv" title="Export to CSV">
              <i class="fa fa-file-excel-o"></i>
            </a>
          </li>
        </ul>
        <div class="clearfix"></div>
      </div>

      <div class="x_content">

        <!-- Filters -->
        <div class="row" style="margin-bottom: 15px;">
          <div class="col-md-12">
            <form method="get" class="form-inline">
              <div class="form-group">
                <label for="start_date"><strong>Start Date:</strong></label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date|default:'' }}" style="margin-left: 10px;">
              </div>
              <div class="form-group" style="margin-left: 20px;">
                <label for="end_date"><strong>End Date:</strong></label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date|default:'' }}" style="margin-left: 10px;">
              </div>
              <button type="submit" class="btn btn-primary" style="margin-left: 20px;">
                <i class="fa fa-refresh"></i> Apply
              </button>
              <a href="?{% if start_date %}start_date={{ start_date }}&{% endif %}{% if end_date %}end_date={{ end_date }}&{% endif %}export=csv" class="btn btn-success" style="margin-left: 10px;">
                <i class="fa fa-download"></i> Export CSV
              </a>
            </form>
          </div>
        </div>

        <!-- Active range notice (term default aware) -->
        {% if used_term_default %}
        <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
          Using current term by default:
          <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong>.
          Included rows: {{ income_tx|length }} inflow(s), {{ expense_tx|length }} outflow(s).
        </div>
        {% else %}
        <div class="alert alert-info" role="alert" style="margin-bottom: 15px;">
          Showing cash flow from <strong>{{ start_date }}</strong> to <strong>{{ end_date }}</strong>.
          Included rows: {{ income_tx|length }} inflow(s), {{ expense_tx|length }} outflow(s).
        </div>
        {% endif %}

        <!-- Sample rows -->
        <div class="row" style="margin-bottom: 10px;">
          <div class="col-md-6">
            <small><strong>Sample inflows (first {{ sample_income|length }}):</strong></small>
            {% if sample_income %}
            <ul class="list-unstyled" style="margin-bottom: 0;">
              {% for t in sample_income %}
              <li><small>{{ t.date|date:"Y-m-d" }} — {{ t.description }} — UGX {{ t.amount|floatformat:0|intcomma }}</small></li>
              {% endfor %}
            </ul>
            {% else %}
            <small>No inflows in range.</small>
            {% endif %}
          </div>
          <div class="col-md-6">
            <small><strong>Sample outflows (first {{ sample_expense|length }}):</strong></small>
            {% if sample_expense %}
            <ul class="list-unstyled" style="margin-bottom: 0;">
              {% for t in sample_expense %}
              <li><small>{{ t.date|date:"Y-m-d" }} — {{ t.description }} — UGX {{ t.amount|floatformat:0|intcomma }}</small></li>
              {% endfor %}
            </ul>
            {% else %}
            <small>No outflows in range.</small>
            {% endif %}
          </div>
        </div>
        <!-- Summary Cards -->
        <div class="row" style="margin-bottom: 20px;">
          <div class="col-md-4">
            <div class="card" style="border-left: 4px solid #28a745; background-color: #f8f9fa;">
              <div class="card-body text-center">
                <h5>Total Inflows</h5>
                <h3 class="text-success">UGX {{ total_income|floatformat:0|intcomma }}</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card" style="border-left: 4px solid #d9534f; background-color: #f8f9fa;">
              <div class="card-body text-center">
                <h5>Total Outflows</h5>
                <h3 class="text-danger">UGX {{ total_expenses|floatformat:0|intcomma }}</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card" style="border-left: 4px solid #337ab7; background-color: #f8f9fa;">
              <div class="card-body text-center">
                <h5>Net Cash Flow</h5>
                <h3 class="{% if net_cash_flow >= 0 %}text-success{% else %}text-danger{% endif %}">
                  UGX {{ net_cash_flow|floatformat:0|intcomma }}
                </h3>
              </div>
            </div>
          </div>
        </div>

        <!-- Daily Net Flow -->
        <div class="row">
          <div class="col-md-12">
            <h3><i class="fa fa-line-chart"></i> Daily Net Flow</h3>
            {% if daily_flow %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                  <tr>
                    <th>Date</th>
                    <th>Net (UGX)</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in daily_flow %}
                  <tr>
                    <td><small>{{ row.date|date:"Y-m-d" }}</small></td>
                    <td>UGX {{ row.net|floatformat:0|intcomma }}</td>
                    <td>
                      {% if row.net >= 0 %}
                        <span class="badge bg-green">Positive</span>
                      {% else %}
                        <span class="badge bg-red">Negative</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
              <div class="alert alert-info">No daily flow data available for the selected period.</div>
            {% endif %}
          </div>
        </div>

        <!-- Detailed Transactions -->
        <div class="row" style="margin-top: 30px;">
          <div class="col-md-6">
            <h3><i class="fa fa-arrow-down"></i> Inflows (Income)</h3>
            {% if income_tx %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount (UGX)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in income_tx %}
                  <tr>
                    <td><small>{{ t.date|date:"Y-m-d" }}</small></td>
                    <td><small>{{ t.description }}</small></td>
                    <td><span class="badge bg-green">UGX {{ t.amount|floatformat:0|intcomma }}</span></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
              <div class="alert alert-info">No inflow transactions found.</div>
            {% endif %}
          </div>

          <div class="col-md-6">
            <h3><i class="fa fa-arrow-up"></i> Outflows (Expenses)</h3>
            {% if expense_tx %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead class="thead-dark">
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount (UGX)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in expense_tx %}
                  <tr>
                    <td><small>{{ t.date|date:"Y-m-d" }}</small></td>
                    <td><small>{{ t.description }}</small></td>
                    <td><span class="badge bg-red">UGX {{ t.amount|floatformat:0|intcomma }}</span></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
              <div class="alert alert-info">No outflow transactions found.</div>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
.badge.bg-green {
  background-color: #27ae60;
  padding: 4px 8px;
  border-radius: 15px;
  font-size: 13px;
  color: white;
}
.badge.bg-red {
  background-color: #e74c3c;
  padding: 4px 8px;
  border-radius: 15px;
  font-size: 13px;
  color: white;
}
</style>
{% endblock %}