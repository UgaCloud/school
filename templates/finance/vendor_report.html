{% extends "../base.html" %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block page_title %}Vendor Payments Report{% endblock %}

{% block content %}
<div class="clearfix"></div>

<div class="row">
  <div class="col-md-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa fa-industry"></i> Vendor Payments Report</h2>
        <ul class="nav navbar-right panel_toolbox">
          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
          <li>
            <a class="print-link" onclick="window.print()" title="Print Report">
              <i class="fa fa-print"></i>
            </a>
          </li>
          <li>
            <a
              href="?{% if selected_vendor %}vendor={{ selected_vendor }}&{% endif %}{% if start_date %}start_date={{ start_date }}&{% endif %}{% if end_date %}end_date={{ end_date }}&{% endif %}{% if selected_academic_year %}academic_year={{ selected_academic_year }}&{% endif %}{% if selected_term %}term={{ selected_term }}&{% endif %}{% if show_all %}show_all=1&{% endif %}export=csv"
              title="Export to CSV">
              <i class="fa fa-file-excel-o"></i>
            </a>
          </li>
        </ul>
        <div class="clearfix"></div>
      </div>

      <div class="x_content">
        <!-- Filters -->
        <div class="row" style="margin-bottom: 15px;">
          <div class="col-md-12">
            <form method="get" class="form-inline">
              <div class="form-group">
                <label for="vendor"><strong>Vendor:</strong></label>
                <select name="vendor" id="vendor" class="form-control" style="min-width: 240px; margin-left: 10px;">
                  <option value="">All Vendors</option>
                  {% for v in vendors %}
                    <option value="{{ v.id }}" {% if selected_vendor and v.id == selected_vendor %}selected{% endif %}>
                      {{ v.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group" style="margin-left: 20px;">
                <label for="start_date"><strong>Start Date:</strong></label>
                <input type="date" name="start_date" id="start_date" class="form-control" value="{{ start_date|default:'' }}" style="margin-left: 10px;">
              </div>

              <div class="form-group" style="margin-left: 20px;">
                <label for="end_date"><strong>End Date:</strong></label>
                <input type="date" name="end_date" id="end_date" class="form-control" value="{{ end_date|default:'' }}" style="margin-left: 10px;">
              </div>

              <div class="form-group" style="margin-left: 20px;">
                <label for="academic_year"><strong>Academic Year:</strong></label>
                <select name="academic_year" id="academic_year" class="form-control" style="min-width: 180px; margin-left: 10px;">
                  <option value="">Current</option>
                  {% if academic_years %}
                    {% for y in academic_years %}
                      <option value="{{ y.id }}" {% if selected_academic_year and y.id == selected_academic_year %}selected{% endif %}>{{ y.academic_year }}</option>
                    {% endfor %}
                  {% endif %}
                </select>
              </div>

              <div class="form-group" style="margin-left: 20px;">
                <label for="term"><strong>Term:</strong></label>
                <select name="term" id="term" class="form-control" style="min-width: 140px; margin-left: 10px;">
                  <option value="">Current</option>
                  {% if terms %}
                    {% for t in terms %}
                      <option value="{{ t.id }}" {% if selected_term and t.id == selected_term %}selected{% endif %}>{{ t.term }}</option>
                    {% endfor %}
                  {% endif %}
                </select>
              </div>

              <div class="form-group form-check" style="margin-left: 20px;">
                <input type="checkbox" class="form-check-input" id="show_all" name="show_all" value="1" {% if show_all %}checked{% endif %}>
                <label class="form-check-label" for="show_all">Show all terms</label>
              </div>

              <button type="submit" class="btn btn-primary" style="margin-left: 20px;">
                <i class="fa fa-refresh"></i> Apply
              </button>

              <a
                href="?{% if selected_vendor %}vendor={{ selected_vendor }}&{% endif %}{% if start_date %}start_date={{ start_date }}&{% endif %}{% if end_date %}end_date={{ end_date }}&{% endif %}{% if selected_academic_year %}academic_year={{ selected_academic_year }}&{% endif %}{% if selected_term %}term={{ selected_term }}&{% endif %}{% if show_all %}show_all=1&{% endif %}export=csv"
                class="btn btn-success"
                style="margin-left: 10px;">
                <i class="fa fa-download"></i> Export CSV
              </a>
            </form>

            <!-- Current Scope Summary -->
            <div class="alert alert-info py-2 mt-2">
              <strong>Scope:</strong>
              {% if show_all %}
                All terms
              {% else %}
                {% if selected_academic_year %}
                  {% for y in academic_years %}{% if y.id == selected_academic_year %}{{ y.academic_year }}{% endif %}{% endfor %}
                {% else %}
                  Current Year
                {% endif %}
                —
                {% if selected_term %}
                  {% for t in terms %}{% if t.id == selected_term %}Term {{ t.term }}{% endif %}{% endfor %}
                {% else %}
                  Current Term
                {% endif %}
              {% endif %}
              {% if start_date or end_date %}
                — Dates: {{ start_date|default:"-" }} to {{ end_date|default:"-" }}
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Executive Summary -->
        <div class="row" style="margin-bottom: 20px;">
          <div class="col-md-12">
            <div class="card" style="border-left: 4px solid #28a745; background-color: #f8f9fa;">
              <div class="card-body" style="padding: 15px 20px;">
                <div class="row">
                  <div class="col-md-4">
                    <h4 class="mb-0"><i class="fa fa-sitemap"></i> Vendors</h4>
                    <p class="text-muted">{{ vendors|length }} total</p>
                  </div>
                  <div class="col-md-4">
                    <h4 class="mb-0"><i class="fa fa-file-text-o"></i> Transactions</h4>
                    <p class="text-muted">{{ breakdown|length }} expenditures</p>
                  </div>
                  <div class="col-md-4">
                    <h4 class="mb-0"><i class="fa fa-money"></i> Total Spent</h4>
                    <p class="text-success"><strong>UGX {{ total_spent|floatformat:0|intcomma }}</strong></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vendor Summary -->
        <div class="row">
          <div class="col-md-12">
            <h3><i class="fa fa-bar-chart"></i> Summary by Vendor</h3>
            {% if summary %}
              <div class="table-responsive">
                <table class="table table-striped table-bordered">
                  <thead class="thead-dark">
                    <tr>
                      <th>Vendor</th>
                      <th>Transactions</th>
                      <th>Total Spent (UGX)</th>
                      <th>% of Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in summary %}
                      <tr>
                        <td><strong>{{ row.vendor.name }}</strong></td>
                        <td>{{ row.count }}</td>
                        <td>UGX {{ row.total|floatformat:0|intcomma }}</td>
                        <td>
                          {% if total_spent %}
                            {{ row.pct|floatformat:1 }}%
                          {% else %}
                            0%
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr style="font-weight: bold; background-color: #f8f9fa;">
                      <td colspan="2">TOTAL</td>
                      <td>UGX {{ total_spent|floatformat:0|intcomma }}</td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">
                No vendor summary available for the selected filters.
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Detailed Expenditures -->
        <div class="row" style="margin-top: 30px;">
          <div class="col-md-12">
            <h3><i class="fa fa-list"></i> Detailed Expenditures</h3>
            {% if breakdown %}
              <div class="table-responsive">
                <table class="table table-striped table-bordered">
                  <thead class="thead-dark">
                    <tr>
                      <th>Date</th>
                      <th>Vendor</th>
                      <th>Department</th>
                      <th>Expense</th>
                      <th>Description</th>
                      <th>Amount (UGX)</th>
                      <th>VAT (UGX)</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for e in breakdown %}
                      <tr>
                        <td><small>{{ e.date_incurred|date:"Y-m-d" }}</small></td>
                        <td><small>{{ e.vendor.name }}</small></td>
                        <td><small>{% if e.budget_item %}{{ e.budget_item.department }}{% else %}N/A{% endif %}</small></td>
                        <td><small>{% if e.budget_item %}{{ e.budget_item.expense }}{% else %}N/A{% endif %}</small></td>
                        <td><small>{{ e.description|default:"-" }}</small></td>
                        <td><span class="badge bg-red">UGX {{ e.amount|floatformat:0|intcomma }}</span></td>
                        <td><small>UGX {{ e.vat|floatformat:0|intcomma }}</small></td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">
                No expenditures found for the selected filters.
              </div>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
  .badge.bg-red {
    background-color: #e74c3c;
    padding: 4px 8px;
    border-radius: 15px;
    font-size: 13px;
    color: white;
  }
</style>
{% endblock %}