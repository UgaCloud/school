{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">

    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    {% endif %}

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h2 class="m-0 font-weight-bold text-primary">Filter Students by Class Stream</h2>
        </div>

        <div class="card-body">
            <form method="get" id="filterForm" class="form-row align-items-center">
                <div class="col-md-3 mb-3">
                    <label for="year_id">Academic Year</label>
                    <select name="year_id" id="year_id" class="form-control" required>
                        <option value="">-- Select Year --</option>
                        {% for y in years %}
                            <option value="{{ y.id }}" {% if y.id|stringformat:"s" == selected_year %}selected{% endif %}>
                                {{ y.academic_year }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3 mb-3">
                    <label for="term_id">Term</label>
                    <select name="term_id" id="term_id" class="form-control" required>
                        <option value="">-- Select Term --</option>
                        {% for t in terms %}
                            <option value="{{ t.id }}" {% if t.id|stringformat:"s" == selected_term %}selected{% endif %}>
                                {{ t.term }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="class_stream_id">Class Stream</label>
                    <select name="class_stream_id" id="class_stream_id" class="form-control" required>
                        <option value="">-- Select Class Stream --</option>
                        {% for cs in academic_class_streams %}
                            <option value="{{ cs.id }}" {% if cs.id|stringformat:"s" == selected_class_stream %}selected{% endif %}>
                                {{ cs.academic_class.Class.name }} - {{ cs.stream.stream }}
                                ({{ cs.academic_class.academic_year.academic_year }} Term {{ cs.academic_class.term.term }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Hidden submit button for accessibility -->
                <button type="submit" id="hiddenSubmit" style="display:none;">Filter</button>
            </form>

            {% if students %}
            <div class="table-responsive mt-4">
                <table id="datatable-checkbox" class="table table-striped table-bordered bulk_action" style="width:100%">
                    <thead >
                        <tr>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Reg No</th>
                            <th>Class</th>
                            <th>Stream</th>
                            <th>Year</th>
                            <th>Term</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td class="text-center">
                                {% if student.photo %}
                                    <img src="{{ student.photo.url }}" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                                {% else %}
                                    <img src="{% static 'img/default_profile.png' %}" class="rounded-circle" style="width: 40px; height: 40px;">
                                {% endif %}
                            </td>
                            <td>{{ student.student_name }}</td>
                            <td>{{ student.reg_no }}</td>
                            <td>{{ student.current_class.name }}</td>
                            <td>{{ student.stream.stream }}</td>
                            <td>{{ student.academic_year.academic_year }}</td>
                            <td>{{ student.term.term }}</td>
                            <td>
                                <a href="{% url 'student_performance' student.id %}" class="btn btn-sm btn-info" title="View Performance">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% elif no_students_message %}
                <div class="alert alert-warning mt-4">{{ no_students_message }}</div>
            {% elif request.GET %}
                <div class="alert alert-warning mt-4">No students found matching your criteria.</div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    if ($.fn.DataTable) {
        $('#studentTable').DataTable({
            "pageLength": 25,
            "responsive": true
        });
    }

    // Auto-submit form when all selects have a value
    $('#filterForm select').on('change', function() {
        const yearVal = $('#year_id').val();
        const termVal = $('#term_id').val();
        const streamVal = $('#class_stream_id').val();

        if (yearVal && termVal && streamVal) {
            $('#filterForm').submit();
        }
    });
});
</script>
{% endblock %}
