{% load static report_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Term Report for {{ student.student_name }} - {{ term }}">
    <meta name="author" content="{{ school.school_name }}">
    <title>Term Report - {{ student.student_name }} | {{ school.school_name }}</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <style>
        /* === CSS Variables for Consistency === */
        :root {
            --primary-color: #002a5c; /* Deep navy for headers */
            --secondary-color: #f7f8fa; /* Light gray for backgrounds */
            --border-color: #d4d7db; /* Subtle gray for borders */
            --text-color: #1a202c; /* Dark gray for text */
            --accent-color: #059669; /* Green for top/bottom borders */
            --highlight-color: #ed64a6; /* Pink for side borders */
            --font-family: 'Times New Roman', Georgia, serif;
            --font-size-base: 10pt;
            --page-width: 18cm; /* A4 width (21cm) - 1.5cm left - 1.5cm right */
            --page-height: 26.7cm; /* A4 height (29.7cm) - 1.5cm top - 1.5cm bottom */
        }

        /* === Global Styles === */
        @page {
            size: A4;
            margin: 1.5cm;
            @top-center {
                content: "{{ school.school_name|default:'School' }} - Term Report";
                font-family: var(--font-family);
                font-size: 9pt;
                color: var(--text-color);
            }
        }
        body {
            font-family: var(--font-family);
            background: #ffffff;
            color: var(--text-color);
            font-size: var(--font-size-base);
            line-height: 1.5;
            width: var(--page-width);
            min-height: var(--page-height);
            margin: 0 auto;
            padding: 0;
            box-sizing: border-box;
            border-left: 3px solid var(--highlight-color);
            border-right: 3px solid var(--highlight-color);
            border-top: 3px solid var(--accent-color);
            border-bottom: 3px solid var(--accent-color);
        }

        /* === Header Section === */
        .report-card-header {
            text-align: center;
            margin-bottom: 1cm;
            padding-bottom: 0.5cm;
            border-bottom: 1.5px solid var(--primary-color);
        }
        .school-branding {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75cm;
            margin-bottom: 0.3cm;
        }
        .school-logo {
            width: 70px;
            height: 70px;
            object-fit: contain;
            border-radius: 3px;
            border: 1px solid var(--border-color);
        }
        .school-name {
            font-size: 16pt;
            font-weight: bold;
            margin: 0;
            color: var(--primary-color);
        }
        .contact-info {
            font-size: 9pt;
            line-height: 1.6;
            color: var(--text-color);
            margin: 0.3cm 0;
        }
        .contact-info p {
            margin: 0.1cm 0;
        }
        .contact-info a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .report-title {
            font-size: 12pt;
            font-weight: 600;
            margin: 0.3cm 0 0;
            color: var(--primary-color);
        }

        /* === Term Selection Form === */
        .term-select {
            margin-bottom: 0.8cm;
            display: flex;
            align-items: center;
            gap: 0.5cm;
            padding: 0.3cm;
            background: var(--secondary-color);
            border-radius: 4px;
        }
        .term-select label {
            font-weight: 600;
            font-size: 9pt;
            color: var(--text-color);
        }
        .term-select select {
            padding: 0.3cm;
            font-size: 9pt;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #ffffff;
            color: var(--text-color);
            width: 120px;
        }

        /* === Student Information === */
        .student-info {
            display: flex;
            align-items: center;
            gap: 0.75cm;
            margin-bottom: 0.8cm;
            padding: 0.5cm;
            background: var(--secondary-color);
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        .student-photo {
            width: 80px;
            height: 100px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            object-fit: cover;
            background: #ffffff;
        }
        .student-details {
            font-size: 9pt;
            color: var(--text-color);
        }
        .student-details div {
            margin-bottom: 0.2cm;
        }
        .student-details strong {
            color: var(--primary-color);
        }

        /* === Summary Information === */
        .summary-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5cm;
            margin-bottom: 0.8cm;
            padding: 0.4cm;
            background: var(--secondary-color);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 9pt;
            color: var(--text-color);
        }
        .summary-info strong {
            color: var(--primary-color);
        }

        /* === Report Table === */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.8cm 0;
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .report-table th,
        .report-table td {
            border: 1px solid var(--border-color);
            padding: 6px;
            text-align: center;
            font-size: 9pt;
            color: var(--text-color);
        }
        .report-table th {
            background: var(--primary-color);
            color: #ffffff;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .report-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        .report-table .overall-row td,
        .report-table .aggregates-row td {
            font-weight: bold;
            background: var(--secondary-color);
            color: var(--primary-color);
        }

        /* === Remarks Section === */
        .remarks {
            margin: 0.8cm 0;
            font-size: 9pt;
            color: var(--text-color);
        }
        .remarks div {
            margin-bottom: 0.6cm;
            padding: 0.4cm;
            border-left: 2px solid var(--primary-color);
            background: var(--secondary-color);
            border-radius: 3px;
        }
        .remarks strong {
            color: var(--primary-color);
        }

        /* === Signature Section === */
        .signature {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5cm;
            margin-top: 1.5cm;
            font-size: 9pt;
            color: var(--text-color);
        }
        .signature div {
            border-top: 1.5px solid var(--primary-color);
            text-align: center;
            padding-top: 0.4cm;
            font-weight: 600;
        }

        /* === Grading Scale === */
        .grading-scale {
            margin-top: 0.8cm;
            font-size: 9pt;
            border-top: 1px solid var(--border-color);
            padding-top: 0.5cm;
            color: var(--text-color);
        }
        .grading-scale strong {
            color: var(--primary-color);
        }
        .grading-scale p {
            margin: 0.3cm 0;
        }

        /* === Print Styles === */
        @media print {
            body {
                width: 21cm;
                min-height: 29.7cm;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border-left: 3px solid var(--highlight-color) !important;
                border-right: 3px solid var(--highlight-color) !important;
                border-top: 3px solid var(--accent-color) !important;
                border-bottom: 3px solid var(--accent-color) !important;
                color: var(--text-color) !important;
            }
            .term-select {
                display: none;
            }
            .report-card-header {
                border-bottom-color: var(--primary-color) !important;
            }
            .report-table {
                width: 100%;
                box-shadow: none;
            }
            .report-table th,
            .report-table td {
                border-color: var(--border-color) !important;
                color: var(--text-color) !important;
            }
            .report-table th {
                background: var(--primary-color) !important;
                color: #ffffff !important;
                border: 1.5px solid var(--border-color) !important;
            }
            .student-info,
            .summary-info,
            .remarks div {
                background: none !important;
                border-color: var(--border-color) !important;
                color: var(--text-color) !important;
            }
            .student-photo,
            .school-logo {
                border-color: var(--border-color) !important;
            }
            a {
                color: var(--text-color) !important;
                text-decoration: none !important;
            }
        }

        /* === Responsive Adjustments for Screen === */
        @media screen and (max-width: 768px) {
            body {
                font-size: 9pt;
                width: 100%;
                border-width: 2px;
            }
            .school-logo,
            .student-photo {
                width: 60px;
                height: 60px;
            }
            .school-name {
                font-size: 14pt;
            }
            .report-title {
                font-size: 11pt;
            }
            .report-table th,
            .report-table td {
                padding: 4px;
                font-size: 8pt;
            }
            .summary-info,
            .signature {
                grid-template-columns: 1fr;
                gap: 0.3cm;
            }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header class="report-card-header" role="banner">
        <div class="school-branding">
            {% if school.school_logo %}
                <img src="{{ school.school_logo.url }}" alt="{{ school.school_name|default:'School' }} Logo" class="school-logo">
            {% else %}
                <img src="{% static 'images/default_logo.png' %}" alt="Default School Logo" class="school-logo">
            {% endif %}
            <h1 class="school-name">{{ school.school_name|default:"School Name Unavailable" }}</h1>
        </div>
        <address class="contact-info">
            <p class="address">{{ school.address|default:"Address Unavailable" }}</p>
            <p class="phone">Phone: {{ school.office_phone_number1|default:"N/A" }}</p>
            {% if school.mobile %}
                <p class="mobile">Mobile: {{ school.mobile }}</p>
            {% endif %}
            <p class="email">Email: {% if school.email %}<a href="mailto:{{ school.email }}" aria-label="Email {{ school.email }}">{{ school.email }}</a>{% else %}N/A{% endif %}</p>
            <p class="website">Website: {% if school.website %}<a href="{{ school.website }}" target="_blank" rel="noopener" aria-label="Visit {{ school.website }}">{{ school.website }}</a>{% else %}N/A{% endif %}</p>
        </address>
        <h2 class="report-title">Term Report - {{ term|default:"Term Unavailable" }}</h2>
    </header>

    <!-- Term Selection Form -->
    <form method="get" class="term-select" aria-label="Select academic term">
        <label for="term-select-id">Select Term:</label>
        <select id="term-select-id" name="term_id" onchange="this.form.submit()">
            <option value="">-- Select Term --</option>
            {% for t in terms %}
                <option value="{{ t.id }}" {% if t.id|stringformat:"s" == selected_term_id %}selected{% endif %}>{{ t.term }}</option>
            {% endfor %}
        </select>
    </form>

    <!-- Student Information -->
    <section class="student-info" aria-label="Student information">
        {% if student.photo %}
            <img src="{{ student.photo.url }}" alt="{{ student.student_name }} Photo" class="student-photo">
        {% else %}
            <img src="{% static 'images/default_student.png' %}" alt="Default Student Photo" class="student-photo">
        {% endif %}
        <div class="student-details">
            <div><strong>Name:</strong> {{ student.student_name|default:"N/A" }}</div>
            <div><strong>Class:</strong> {{ student.current_class.name|default:"N/A" }} {{ student.stream.stream|default:"" }}</div>
        </div>
    </section>

    <!-- Summary Information -->
    <section class="summary-info" aria-label="Academic summary">
        <div><strong>Academic Year:</strong> {{ academic_year|default:"N/A" }}</div>
        <div><strong>Admission No:</strong> {{ student.admission_number|default:"N/A" }}</div>
    </section>

    <!-- Report Table -->
    <table class="report-table" aria-label="Student term report table">
        <thead>
            <tr>
                <th scope="col">No.</th>
                <th scope="col">Subject</th>
                {% for at in assessment_types %}
                    <th scope="col">{{ at.name }}<br>Score</th>
                {% endfor %}
                <th scope="col">Average</th>
            </tr>
        </thead>
        <tbody>
            {% for item in report_data %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ item.subject|default:"N/A" }}</td>
                    {% for at in assessment_types %}
                        <td>{{ item.assessments|lookup:at.name|lookup:'score'|default:"-" }}</td>
                    {% endfor %}
                    <td>{{ item.average|floatformat:1|default:"-" }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="{{ assessment_types|length|add:3 }}">No results available for this term.</td></tr>
            {% endfor %}
            <tr class="aggregates-row">
                <td colspan="2"><strong>Total Aggregates:</strong></td>
                {% for at in assessment_types %}
                    <td><strong>{{ report_data|aggregate_points:at.name|floatformat:1|default:"-" }}</strong></td>
                {% endfor %}
                <td></td>
            </tr>
            <tr class="overall-row">
                <td colspan="{{ assessment_types|length|add:2 }}"><strong>Overall Average:</strong></td>
                <td><strong>{{ overall_average|floatformat:1|default:"-" }}</strong></td>
            </tr>
        </tbody>
    </table>

    <!-- Remarks Section -->
    <section class="remarks" aria-label="Teacher remarks">
        <div><strong>Class Teacher's Remark:</strong> ............................................................</div>
        <div><strong>Head Teacher's Remark:</strong> ...........................................................</div>
    </section>

    <!-- Signature Section -->
    <section class="signature" aria-label="Signatures">
        <div>Class Teacher</div>
        <div>Head Teacher</div>
    </section>

    <!-- Grading Scale -->
    <section class="grading-scale" aria-label="Grading scale">
        <strong>Grading Information:</strong>
        <p>Scores are out of 100. Higher scores indicate better performance.</p>
    </section>
</body>
</html>