{% extends 'base.html' %}
{% load static dict_extras %}

{% block title %}Combined Assessments{% endblock %}

{% block content %}
<div class="page-title">
  <div class="title_left">
    <h3><i class="fa fa-print"></i> Combined Assessments Report</h3>
  </div>
  <div class="title_right">
    <div class="pull-right">
      <a
        class="btn btn-default"
        href="{% url 'class_assessment_combined_print' %}?academic_year_id={{ selected_year_id }}&term_id={{ selected_term_id }}&class_id={{ selected_class_id }}{% for id in selected_assessment_type_ids %}&assessment_type_ids={{ id }}{% endfor %}"
        target="_blank"
        rel="noopener"
      >
        <i class="fa fa-print"></i> Print Combined Reports
      </a>
    </div>
  </div>
</div>

<div class="clearfix"></div>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
{% endif %}

<style>
  @media print {
    .no-print { display: none !important; }
    .x_panel { box-shadow: none !important; border: 1px solid #ddd !important; }
    a[href]:after { content: "" !important; }
  }
  .filter-bar .form-group { margin-right: 12px; margin-bottom: 8px; }
  .sticky-header th { position: sticky; top: 0; background: #f7f7f7; z-index: 1; }
  .table-compact td, .table-compact th { padding: 6px 8px !important; font-size: 12px; }
  .student-card-title { margin: 0; font-weight: 600; font-size: 14px; }
  .muted { color: #888; }
</style>

<div class="x_panel">
  <div class="x_title">
    <h2>Filters</h2>
    <div class="clearfix"></div>
  </div>
  <div class="x_content">
    <form method="get" class="form-inline filter-bar">
      <div class="form-group">
        <label for="academic_year_id">Academic Year</label>
        <select name="academic_year_id" id="academic_year_id" class="form-control">
          <option value="">-- Select --</option>
          {% for y in academic_years %}
            <option value="{{ y.id }}" {% if selected_year_id == y.id|stringformat:"s" %}selected{% endif %}>
              {{ y.academic_year }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="term_id">Term</label>
        <select name="term_id" id="term_id" class="form-control">
          <option value="">-- Select --</option>
          {% for t in terms %}
            <option value="{{ t.id }}" {% if selected_term_id == t.id|stringformat:"s" %}selected{% endif %}>
              {{ t.term }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="class_id">Class</label>
        <select name="class_id" id="class_id" class="form-control">
          <option value="">-- Select --</option>
          {% for c in classes %}
            <option value="{{ c.id }}" {% if selected_class_id == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label>Assessment Types</label><br/>
        <div class="well well-sm" style="max-height:140px; overflow:auto; min-width: 280px; margin-bottom:0;">
          {% for at in assessment_types %}
            <label class="checkbox" style="display:block; margin-bottom:6px;">
              <input
                type="checkbox"
                name="assessment_type_ids"
                value="{{ at.id }}"
                {% if at.id|stringformat:"s" in selected_assessment_type_ids %}checked{% endif %}
              />
              {{ at.name }} {% if at.weight %}<span class="muted">(w={{ at.weight }})</span>{% endif %}
            </label>
          {% endfor %}
        </div>
      </div>

      <div class="form-group">
        <button type="submit" class="btn btn-primary">
          <i class="fa fa-filter"></i> Apply
        </button>
        <a href="?{% if selected_year_id %}academic_year_id={{ selected_year_id }}&{% endif %}{% if selected_term_id %}term_id={{ selected_term_id }}&{% endif %}" class="btn btn-default">
          Reset
        </a>
      </div>
    </form>
  </div>
</div>

{% if ready and class_obj %}
  <div class="x_panel">
    <div class="x_title">
      <h2>
        {{ class_obj.Class.name }} | {{ class_obj.term.term }} | {{ class_obj.academic_year.academic_year }}
        <small>
          &mdash; Assessments:
          {% for at in selected_assessment_types %}
            <span class="label label-default" style="margin-right:4px;">{{ at.name }}</span>
          {% endfor %}
        </small>
      </h2>
      <div class="clearfix"></div>
    </div>

    <div class="x_content">
      {% if students_data|length == 0 %}
        <p class="text-warning">No students found for the selected criteria.</p>
      {% else %}
        {% for row in students_data %}
          <div class="x_panel">
            <div class="x_title">
              <h3 class="student-card-title">
                {{ row.no }}. {{ row.student.student_name }}
                <small class="muted">Reg: {{ row.student.reg_no }}</small>
              </h3>
              <div class="clearfix"></div>
            </div>
            <div class="x_content">
              <div class="table-responsive">
                <table class="table table-striped table-bordered table-compact">
                  <thead class="sticky-header">
                    <tr>
                      <th style="min-width:40px;">#</th>
                      <th style="min-width:220px;">Subject</th>
                      {% for at in selected_assessment_types %}
                        <th style="min-width:80px; text-align:center;">{{ at.name }}</th>
                      {% endfor %}
                      <th style="min-width:80px; text-align:center;">Average</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for subj in subjects %}
                      <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ subj }}</td>
                        {% for at in selected_assessment_types %}
                          {% with sdata=row.subjects|get_item:subj %}
                            {% if sdata %}
                              {% with score=sdata.scores|get_item:at.id %}
                                <td style="text-align:center;">{{ score|default:"-" }}</td>
                              {% endwith %}
                            {% else %}
                              <td style="text-align:center;">-</td>
                            {% endif %}
                          {% endwith %}
                        {% endfor %}

                        {% with sdata=row.subjects|get_item:subj %}
                          <td style="text-align:center;">
                            {% if sdata and sdata.avg is not None %}
                              {{ sdata.avg }}
                            {% else %}-{% endif %}
                          </td>
                        {% endwith %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
{% else %}
  <div class="x_panel">
    <div class="x_content">
      <p class="muted">
        Select Academic Year, Term, Class and at least two Assessment Types (e.g., BEGINNING OF TERM and MID OF TERM) then click Apply to render a print-ready report.
      </p>
    </div>
  </div>
{% endif %}

<script>
  // Simple helper: when Academic Year changes, optionally clear term
  (function(){
    var yearSel = document.getElementById('academic_year_id');
    var termSel = document.getElementById('term_id');
    if (yearSel) {
      yearSel.addEventListener('change', function() {
        if (termSel) { termSel.selectedIndex = 0; }
      });
    }
  })();
</script>
{% endblock %}