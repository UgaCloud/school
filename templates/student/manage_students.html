{% extends "../base.html" %}
{% load crispy_forms_tags %}
{% load humanize %}

{% block page_title %}Student Management{% endblock page_title %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fa fa-graduation-cap text-primary me-2"></i>
                        Student Management
                    </h2>
                    <p class="text-muted mb-0">
                        Manage student records, enrollment, and academic information
                    </p>
            </div>
                <div class="d-flex gap-2">
                {% if request.user.is_superuser %}
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target=".add-student-modal">
                            <i class="fa fa-plus me-1"></i> Add Student
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown">
                                <i class="fa fa-download me-1"></i> Import/Export
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="{% url 'download_student_template' %}">
                                    <i class="fa fa-download me-2"></i>Download Template
                                </a>
                                <a class="dropdown-item" href="#" data-toggle="modal" data-target=".bulk-upload-modal">
                                    <i class="fa fa-upload me-2"></i>Bulk Upload
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ total_all }}</h4>
                            <p class="mb-0">Total Students</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fa fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ total_active }}</h4>
                            <p class="mb-0">Active Students</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fa fa-user-check fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ total_inactive }}</h4>
                            <p class="mb-0">Inactive Students</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fa fa-user-plus fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ students|length|floatformat:0 }}</h4>
                            <p class="mb-0">Pending Actions</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fa fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-search"></i></span>
                                </div>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search students...">
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-6 mb-3">
                            <select class="form-control" id="classFilter">
                                <option value="">All Classes</option>
                                <!-- Add class options dynamically -->
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-6 mb-3">
                            <select class="form-control" id="genderFilter">
                                <option value="">All Genders</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-6 mb-3">
                            <select class="form-control" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-6 mb-3">
                            <button class="btn btn-outline-secondary w-100" id="clearFilters">
                                <i class="fa fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="row mb-3" id="bulkActions" style="display: none;">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <span class="me-3"><strong id="selectedCount">0</strong> students selected</span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" id="bulkEdit">
                                <i class="fa fa-edit me-1"></i>Edit
                            </button>
                            <button class="btn btn-outline-danger" id="bulkDelete">
                                <i class="fa fa-trash me-1"></i>Delete
                            </button>
                            <button class="btn btn-outline-success" id="bulkExport">
                                <i class="fa fa-download me-1"></i>Export
                        </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Cards/Table View Toggle -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" id="tableViewBtn">
                        <i class="fa fa-table me-1"></i>Table View
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="cardViewBtn">
                        <i class="fa fa-th-large me-1"></i>Card View
                    </button>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-2">Show:</span>
                    <select class="form-control form-control-sm" id="pageSize" style="width: auto;" onchange="changePageSize(this.value)">
                        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Table View -->
    <div class="row" id="tableView">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="studentsTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th width="60">#</th>
                                    <th>Student</th>
                                    <th>Registration No.</th>
                                    <th>Class & Stream</th>
                                    <th>Contact</th>
                                    <th>Status</th>
                            {% if request.user.is_superuser %}
                                        <th width="120">Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                                {% for student in students %}
                                    <tr data-student-id="{{ student.id }}" data-gender="{{ student.gender }}" data-class="{{ student.current_class.code }}" data-stream="{{ student.stream.stream }}" data-status="{% if status != 'all' %}{{ status }}{% endif %}">
                                        <td>
                                            <input type="checkbox" class="form-check-input student-checkbox" value="{{ student.id }}">
                                        </td>
                                        <td class="text-muted">{{ forloop.counter }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm me-3">
                                                    {% if student.photo %}
                                                        <img src="{{ student.photo.url }}" class="rounded-circle" alt="Avatar" style="width: 40px; height: 40px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                            <i class="fa fa-user text-white"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">{{ student.student_name }}</h6>
                                                    <small class="text-muted">
                                                        <i class="fa fa-{{ student.gender|yesno:'mars,venus' }} me-1"></i>
                                                        {% if student.gender == 'M' %}Male{% else %}Female{% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark">{{ student.reg_no }}</span>
                                        </td>
                                        <td>
                                            <div>
                                                <span class="badge bg-primary">{{ student.current_class.code }}</span>
                                                <span class="badge bg-secondary">{{ student.stream.stream }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <small class="text-muted">{{ student.contact }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            {% if status == 'inactive' %}
                                                <span class="badge bg-secondary">Inactive</span>
                                            {% else %}
                                                <span class="badge bg-success">Active</span>
                                            {% endif %}
                                </td>
                                {% if request.user.is_superuser %}
                                    <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{% url 'student_details_page' student.id %}" class="btn btn-outline-primary btn-sm" title="View Details">
                                                        <i class="fa fa-eye"></i>
                                                    </a>
                                                    <a href="{% url 'edit_student_page' student.id %}" class="btn btn-outline-warning btn-sm" title="Edit">
                                            <i class="fa fa-edit"></i>
                                        </a>
                                                    <a href="{% url 'delete_student_page' student.id %}" class="btn btn-outline-danger btn-sm" title="Delete" onclick="return confirm('Are you sure you want to delete this student?')">
                                                        <i class="fa fa-trash"></i>
                                                    </a>
                                                </div>
                                    </td>
                                {% endif %}
                            </tr>
                        {% empty %}
                            <tr>
                                        <td colspan="{% if request.user.is_superuser %}8{% else %}7{% endif %}" class="text-center py-5">
                                            <div class="text-muted">
                                                <i class="fa fa-users fa-3x mb-3"></i>
                                                <h5>No Students Found</h5>
                                                <p>No students are currently registered in the system.</p>
                                                {% if request.user.is_superuser %}
                                                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target=".add-student-modal">
                                                        <i class="fa fa-plus me-1"></i>Add First Student
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card View -->
    <div class="row" id="cardView" style="display: none;">
        <div class="col-12">
            <div class="row" id="studentCards">
                {% for student in students %}
                    <div class="col-lg-4 col-md-6 mb-4" data-student-id="{{ student.id }}" data-gender="{{ student.gender }}" data-class="{{ student.current_class.code }}" data-stream="{{ student.stream.stream }}" data-status="{% if status != 'all' %}{{ status }}{% endif %}">
                        <div class="card h-100 shadow-sm student-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="avatar-lg me-3">
                                        {% if student.photo %}
                                            <img src="{{ student.photo.url }}" class="rounded-circle" alt="Avatar" style="width: 60px; height: 60px; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                <i class="fa fa-user text-white fa-2x"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <h5 class="mb-1">{{ student.student_name }}</h5>
                                        <p class="text-muted mb-0">{{ student.reg_no }}</p>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input student-checkbox" value="{{ student.id }}">
                                    </div>
                                </div>
                                
                                <div class="row text-center mb-3">
                                    <div class="col-6">
                                        <div class="border-end">
                                            <h6 class="mb-0 text-primary">{{ student.current_class.code }}</h6>
                                            <small class="text-muted">Class</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="mb-0 text-info">{{ student.stream.stream }}</h6>
                                        <small class="text-muted">Stream</small>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-{% if student.gender == 'M' %}primary{% else %}success{% endif %}">
                                        <i class="fa fa-{% if student.gender == 'M' %}mars{% else %}venus{% endif %} me-1"></i>
                                        {% if student.gender == 'M' %}Male{% else %}Female{% endif %}
                                    </span>
                                    {% if status == 'inactive' %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% else %}
                                        <span class="badge bg-success">Active</span>
                                    {% endif %}
                                </div>

                                <div class="text-muted mb-3">
                                    <small><i class="fa fa-phone me-1"></i>{{ student.contact }}</small>
                                </div>

                                {% if request.user.is_superuser %}
                                    <div class="btn-group w-100">
                                        <a href="{% url 'student_details_page' student.id %}" class="btn btn-outline-primary btn-sm">
                                            <i class="fa fa-eye me-1"></i>View
                                        </a>
                                        <a href="{% url 'edit_student_page' student.id %}" class="btn btn-outline-warning btn-sm">
                                            <i class="fa fa-edit me-1"></i>Edit
                                        </a>
                                        <a href="{% url 'delete_student_page' student.id %}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this student?')">
                                            <i class="fa fa-trash me-1"></i>Delete
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Student pagination">
                <ul class="pagination justify-content-center">
                    {% if students.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1&status={{ status }}&per_page={{ per_page }}" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ students.previous_page_number }}&status={{ status }}&per_page={{ per_page }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&laquo;&laquo;</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">&laquo;</span>
                        </li>
                    {% endif %}

                    {% for num in students.paginator.page_range %}
                        {% if students.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > students.number|add:'-3' and num < students.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}&status={{ status }}&per_page={{ per_page }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if students.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ students.next_page_number }}&status={{ status }}&per_page={{ per_page }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ students.paginator.num_pages }}&status={{ status }}&per_page={{ per_page }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&raquo;</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">&raquo;&raquo;</span>
                        </li>
                    {% endif %}
                </ul>
                <div class="text-center text-muted mt-2">
                    <small>
                        Showing {{ students.start_index }} to {{ students.end_index }} of {{ students.paginator.count }} students
                    </small>
                </div>
            </nav>
        </div>
    </div>
</div>

<!-- Add Student Modal -->
<div class="modal fade add-student-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h4 class="modal-title">
                    <i class="fa fa-user-plus me-2"></i>Add New Student
                </h4>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'add_student' %}" enctype="multipart/form-data" id="addStudentForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-12">
                            {{ student_form.student_name|as_crispy_field }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            {{ student_form.gender|as_crispy_field }}
                        </div>
                        <div class="col-md-4">
                            {{ student_form.birthdate|as_crispy_field }}
                        </div>
                        <div class="col-md-4">
                            {{ student_form.nationality|as_crispy_field }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {{ student_form.religion|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ student_form.photo|as_crispy_field }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            {{ student_form.address|as_crispy_field }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            {{ student_form.guardian|as_crispy_field }}
                        </div>
                        <div class="col-md-4">
                            {{ student_form.relationship|as_crispy_field }}
                        </div>
                        <div class="col-md-4">
                            {{ student_form.contact|as_crispy_field }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            {{ student_form.academic_year|as_crispy_field }}
                        </div>
                        <div class="col-md-4">
                            {{ student_form.current_class|as_crispy_field }}
                        </div>
                        <div class="col-md-4">
                            {{ student_form.stream|as_crispy_field }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {{ student_form.term|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ student_form.is_active|as_crispy_field }}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fa fa-times me-1"></i>Cancel
                </button>
                <button type="submit" form="addStudentForm" class="btn btn-primary">
                    <i class="fa fa-save me-1"></i>Add Student
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Upload Modal -->
<div class="modal fade bulk-upload-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h4 class="modal-title">
                    <i class="fa fa-upload me-2"></i>Bulk Student Upload
                </h4>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fa fa-info-circle me-2"></i>
                    <strong>Instructions:</strong> Upload a CSV file with student data. 
                    <a href="{% url 'download_student_template' %}" class="alert-link">Download template</a> for the correct format.
                </div>
                <form method="POST" action="{% url 'bulk_student_registration' %}" enctype="multipart/form-data" id="bulkUploadForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="{{ csv_form.file_name.id_for_label }}" class="form-label">
                            <i class="fa fa-file-csv me-1"></i>CSV File
                        </label>
                        {{ csv_form.file_name }}
                        <small class="form-text text-muted">
                            Supported formats: .csv, .xlsx. Maximum file size: 10MB
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fa fa-times me-1"></i>Cancel
                </button>
                <button type="submit" form="bulkUploadForm" class="btn btn-success">
                    <i class="fa fa-upload me-1"></i>Upload Students
                </button>
            </div>
        </div>
    </div>
</div> 

<!-- Custom CSS -->
<style>
.avatar-sm {
    width: 40px;
    height: 40px;
}

.avatar-lg {
    width: 60px;
    height: 60px;
}

.student-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    border: 1px solid #e9ecef;
}

.student-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
}

.badge {
    font-size: 0.75em;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.opacity-75 {
    opacity: 0.75;
}

@media (max-width: 768px) {
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .btn-group {
        width: 100%;
    }
    
    .btn-group .btn {
        flex: 1;
    }
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Animation for view switching */
.fade-in {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // View toggle functionality
    const tableViewBtn = document.getElementById('tableViewBtn');
    const cardViewBtn = document.getElementById('cardViewBtn');
    const tableView = document.getElementById('tableView');
    const cardView = document.getElementById('cardView');

    tableViewBtn.addEventListener('click', function() {
        tableView.style.display = 'block';
        cardView.style.display = 'none';
        tableView.classList.add('fade-in');
        tableViewBtn.classList.add('active');
        cardViewBtn.classList.remove('active');
    });

    cardViewBtn.addEventListener('click', function() {
        tableView.style.display = 'none';
        cardView.style.display = 'block';
        cardView.classList.add('fade-in');
        cardViewBtn.classList.add('active');
        tableViewBtn.classList.remove('active');
    });

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const studentsTable = document.getElementById('studentsTable');
    const studentCards = document.querySelectorAll('.student-card');

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        filterStudents(searchTerm);
    });

    function filterStudents(searchTerm) {
        // Filter table rows
        const rows = studentsTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const studentName = row.querySelector('h6')?.textContent.toLowerCase() || '';
            const regNo = row.querySelector('.badge')?.textContent.toLowerCase() || '';
            const shouldShow = studentName.includes(searchTerm) || regNo.includes(searchTerm);
            row.style.display = shouldShow ? '' : 'none';
        });

        // Filter cards
        studentCards.forEach(card => {
            const cardElement = card.closest('[data-student-id]');
            const studentName = card.querySelector('h5')?.textContent.toLowerCase() || '';
            const regNo = card.querySelector('p')?.textContent.toLowerCase() || '';
            const shouldShow = studentName.includes(searchTerm) || regNo.includes(searchTerm);
            cardElement.style.display = shouldShow ? '' : 'none';
        });
    }

    // Filter functionality
    const classFilter = document.getElementById('classFilter');
    const genderFilter = document.getElementById('genderFilter');
    const statusFilter = document.getElementById('statusFilter');
    // Initialize dropdown from server-side status (active by default)
    const initialStatus = '{{ status }}';
    if (initialStatus && initialStatus !== 'all') { statusFilter.value = initialStatus; }
    const clearFilters = document.getElementById('clearFilters');

    [classFilter, genderFilter, statusFilter].forEach(filter => {
        filter.addEventListener('change', applyFilters);
    });

    clearFilters.addEventListener('click', function() {
        classFilter.value = '';
        genderFilter.value = '';
        statusFilter.value = '';
        searchInput.value = '';
        applyFilters();
    });

    function applyFilters() {
        const classValue = classFilter.value;
        const genderValue = genderFilter.value;
        const statusValue = statusFilter.value;
        const searchValue = searchInput.value.toLowerCase();

        // Filter table rows
        const rows = studentsTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const studentName = row.querySelector('h6')?.textContent.toLowerCase() || '';
            const regNo = row.querySelector('.badge')?.textContent.toLowerCase() || '';
            
            // Use data attributes for reliable filtering
            const studentGender = row.getAttribute('data-gender');
            const studentClass = row.getAttribute('data-class');
            
            const matchesSearch = studentName.includes(searchValue) || regNo.includes(searchValue);
            
            // Fix gender matching using data attribute
            let matchesGender = true;
            if (genderValue) {
                matchesGender = studentGender === genderValue;
                console.log('Row:', studentName, 'Data Gender:', studentGender, 'Filter:', genderValue, 'Matches:', matchesGender);
            }
            
            const matchesClass = !classValue || studentClass.toLowerCase().includes(classValue.toLowerCase());

            // Status from data attribute; empty when viewing "all"
            const studentStatus = row.getAttribute('data-status') || '';
            const matchesStatus = !statusValue || (studentStatus === statusValue);

            const shouldShow = matchesSearch && matchesGender && matchesClass && matchesStatus;
            row.style.display = shouldShow ? '' : 'none';
        });

        // Filter cards
        studentCards.forEach(card => {
            const cardElement = card.closest('[data-student-id]');
            const studentName = card.querySelector('h5')?.textContent.toLowerCase() || '';
            const regNo = card.querySelector('p')?.textContent.toLowerCase() || '';
            
            // Use data attributes for reliable filtering
            const studentGender = cardElement.getAttribute('data-gender');
            const studentClass = cardElement.getAttribute('data-class');
            
            const matchesSearch = studentName.includes(searchValue) || regNo.includes(searchValue);
            
            // Fix gender matching using data attribute
            let matchesGender = true;
            if (genderValue) {
                matchesGender = studentGender === genderValue;
                console.log('Card:', studentName, 'Data Gender:', studentGender, 'Filter:', genderValue, 'Matches:', matchesGender);
            }
            
            const matchesClass = !classValue || studentClass.toLowerCase().includes(classValue.toLowerCase());
            
            // Status from data attribute; empty when viewing "all"
            const cardStatus = cardElement.getAttribute('data-status') || '';
            const matchesStatus = !statusValue || (cardStatus === statusValue);

            const shouldShow = matchesSearch && matchesGender && matchesClass && matchesStatus;
            cardElement.style.display = shouldShow ? '' : 'none';
        });
    }

    // Bulk selection functionality
    const selectAllCheckbox = document.getElementById('selectAll');
    const studentCheckboxes = document.querySelectorAll('.student-checkbox');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');

    selectAllCheckbox.addEventListener('change', function() {
        studentCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActions();
    });

    studentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActions);
    });

    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');
        const count = checkedBoxes.length;
        
        selectedCount.textContent = count;
        bulkActions.style.display = count > 0 ? 'block' : 'none';
        
        // Update select all checkbox state
        selectAllCheckbox.checked = count === studentCheckboxes.length;
        selectAllCheckbox.indeterminate = count > 0 && count < studentCheckboxes.length;
    }

    // Bulk actions
    document.getElementById('bulkEdit').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length > 0) {
            alert(`Edit ${selectedIds.length} students: ${selectedIds.join(', ')}`);
        }
    });

    document.getElementById('bulkDelete').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length > 0) {
            if (confirm(`Are you sure you want to delete ${selectedIds.length} students?`)) {
                alert(`Delete ${selectedIds.length} students: ${selectedIds.join(', ')}`);
            }
        }
    });

    document.getElementById('bulkExport').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length > 0) {
            alert(`Export ${selectedIds.length} students: ${selectedIds.join(', ')}`);
        }
    });

    // Populate class filter
    const classOptions = new Set();
    document.querySelectorAll('.badge.bg-primary').forEach(badge => {
        classOptions.add(badge.textContent.trim());
    });
    
    const classFilterSelect = document.getElementById('classFilter');
    classOptions.forEach(className => {
        const option = document.createElement('option');
        option.value = className.toLowerCase();
        option.textContent = className;
        classFilterSelect.appendChild(option);
    });

    // Form validation
    const addStudentForm = document.getElementById('addStudentForm');
    const bulkUploadForm = document.getElementById('bulkUploadForm');

    addStudentForm.addEventListener('submit', function(e) {
        const requiredFields = this.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields.');
        }
    });

    bulkUploadForm.addEventListener('submit', function(e) {
        const fileInput = this.querySelector('input[type="file"]');
        if (!fileInput.files.length) {
            e.preventDefault();
            alert('Please select a file to upload.');
        }
    });

    // Page size change function
    window.changePageSize = function(perPage) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('per_page', perPage);
        urlParams.set('page', '1'); // Reset to first page when changing page size
        window.location.search = urlParams.toString();
    };

    // Auto-refresh functionality (optional)
    setInterval(function() {
        // You can add auto-refresh logic here if needed
    }, 300000); // 5 minutes
});
</script>
{% endblock content %}
